<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التوظيف - Al-Zahrani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- إضافة Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, deleteDoc, getDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWQ2q1HU_LLQKkp2KRlOZ1FdF0bI6jBbM",
            authDomain: "zahrani-bc3ae.firebaseapp.com",
            projectId: "zahrani-bc3ae",
            storageBucket: "zahrani-bc3ae.firebasestorage.app",
            messagingSenderId: "405206070457",
            appId: "1:405206070457:web:fedf4204571d910030d768"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firestoreFunctions = { collection, addDoc, getDocs, query, orderBy, doc, deleteDoc, getDoc, updateDoc, where };

        console.log("✅ Firebase initialized successfully");
        window.firebaseReady = true;
        if (window.onFirebaseReady) window.onFirebaseReady();
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Tajawal', sans-serif; }
        :root {
            --primary: #1a365d; --secondary: #2d3748; --accent: #3182ce; --success: #38a169;
            --warning: #d69e2e; --danger: #e53e3e; --light: #f7fafc; --dark: #2d3748;
            --gradient: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
        }
        
        body { 
            background: linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), 
                        url('https://i.ibb.co/0Q6qW8g/background.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            z-index: -1;
        }
        
        .container { 
            width: 100%; 
            max-width: 1400px; 
            position: relative;
            z-index: 1;
        }
        
        .header { 
            background: var(--gradient); 
            color: white; 
            padding: 25px; 
            border-radius: 20px; 
            text-align: center; 
            margin-bottom: 30px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); 
            position: relative; 
            overflow: hidden; 
        }
        .header::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 5px; 
            background: linear-gradient(90deg, var(--accent), var(--success)); 
        }
        .video-container { 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto 25px; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.3);
        }
        .video-container video { 
            width: 100%; 
            height: auto; 
            display: block; 
            max-height: 500px;
            object-fit: cover;
        }
        .main-title { font-size: 2.8rem; margin-bottom: 15px; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .sub-title { font-size: 1.4rem; opacity: 0.95; font-weight: 500; }
        
        .nav-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .nav-card { background: white; padding: 35px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; transition: all 0.4s ease; cursor: pointer; border: 2px solid transparent; position: relative; overflow: hidden; }
        .nav-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: var(--accent); transform: scaleX(0); transition: transform 0.4s ease; }
        .nav-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); border-color: var(--accent); }
        .nav-card:hover::before { transform: scaleX(1); }
        .nav-icon { font-size: 4rem; color: var(--accent); margin-bottom: 25px; }
        .nav-title { font-size: 1.8rem; color: var(--primary); margin-bottom: 20px; font-weight: 700; }
        .nav-description { color: var(--secondary); line-height: 1.7; font-size: 1.1rem; }
        
        .form-container { background: white; padding: 35px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; display: none; }
        .form-title { color: var(--primary); font-size: 2.2rem; margin-bottom: 30px; text-align: center; font-weight: 700; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; font-weight: 700; color: var(--dark); font-size: 1.1rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 15px 18px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: white; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 4px rgba(49, 130, 206, 0.15); }
        .form-textarea { resize: vertical; min-height: 120px; }
        
        .image-preview { margin-top: 12px; text-align: center; }
        .image-preview img { max-width: 250px; max-height: 180px; border-radius: 10px; border: 2px solid #e2e8f0; }
        .remove-image { margin-top: 8px; background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        
        .btn { padding: 15px 35px; border: none; border-radius: 10px; font-size: 17px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #2c5aa0; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(49, 130, 206, 0.4); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-full { width: 100%; }
        .btn-group { display: flex; gap: 12px; margin-top: 25px; flex-wrap: wrap; }
        .btn-small { padding: 10px 18px; font-size: 15px; }
        
        .table-container { background: white; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 30px; }
        .table-header { background: var(--gradient); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .table-title { font-size: 1.8rem; font-weight: 700; }
        .filters { display: flex; gap: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-label { font-size: 1rem; opacity: 0.95; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f7fafc; padding: 18px; text-align: right; font-weight: 700; color: var(--dark); border-bottom: 3px solid #e2e8f0; font-size: 1.05rem; }
        .data-table td { padding: 18px; border-bottom: 2px solid #e2e8f0; text-align: right; }
        .data-table tr:hover { background: #f7fafc; }
        .status-badge { padding: 8px 16px; border-radius: 25px; font-size: 0.9rem; font-weight: 700; }
        .status-active { background: #c6f6d5; color: #22543d; }
        .status-expired { background: #fed7d7; color: #c53030; }
        .status-warning { background: #fefcbf; color: #744210; }
        
        .login-container { background: white; padding: 45px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); max-width: 450px; margin: 0 auto; display: none; }
        .login-title { color: var(--primary); font-size: 2.2rem; margin-bottom: 35px; text-align: center; font-weight: 700; }
        
        .lang-toggle { position: fixed; top: 25px; left: 25px; background: var(--accent); color: white; border: none; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-weight: 700; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; font-size: 1rem; }
        
        .loading { display: inline-block; width: 24px; height: 24px; border: 3px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        
        .job-announcement { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 35px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); text-align: center; }
        .job-announcement h2 { font-size: 2.5rem; margin-bottom: 25px; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .job-announcement h3 { font-size: 1.8rem; margin: 25px 0 20px; font-weight: 700; }
        .job-announcement p { font-size: 1.3rem; margin-bottom: 20px; line-height: 1.8; font-weight: 500; }
        .job-announcement ul { text-align: right; margin: 25px 0; padding-right: 25px; }
        .job-announcement li { margin-bottom: 15px; font-size: 1.2rem; line-height: 1.7; }
        
        .success-message { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; border-radius: 20px; margin-top: 30px; text-align: center; display: none; }
        
        .expiry-warning { color: var(--warning); font-size: 1rem; margin-top: 8px; display: none; }
        .expiry-info { color: var(--accent); font-size: 1rem; margin-top: 8px; display: none; }
        
        .verification-container { background: white; padding: 45px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); max-width: 450px; margin: 0 auto; display: none; }
        .verification-title { color: var(--primary); font-size: 2.2rem; margin-bottom: 35px; text-align: center; font-weight: 700; }
        
        .profile-header { background: var(--gradient); color: white; padding: 35px; border-radius: 20px; margin-bottom: 30px; display: flex; align-items: center; gap: 25px; }
        .profile-image { width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; object-fit: cover; }
        .profile-info { flex: 1; }
        .profile-name { font-size: 2.2rem; font-weight: 800; margin-bottom: 8px; }
        .profile-role { font-size: 1.3rem; opacity: 0.95; }
        
        .otp-input { text-align: center; font-size: 1.8rem; font-weight: bold; letter-spacing: 10px; padding: 20px; }
        .otp-message { background: #e6fffa; border: 2px solid #38a169; color: #22543d; padding: 20px; border-radius: 10px; margin: 25px 0; text-align: center; font-weight: 700; font-size: 1.1rem; }
        
        .supervisor-nav { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .supervisor-nav-btn { flex: 1; min-width: 220px; }
        
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid var(--accent); }
        .stat-value { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
        .stat-label { font-size: 1.2rem; color: var(--secondary); font-weight: 600; }
        
        .permission-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .permission-checkbox input { width: 20px; height: 20px; }
        
        @media (max-width: 768px) {
            .nav-cards, .form-grid { grid-template-columns: 1fr; }
            .table-header { flex-direction: column; align-items: stretch; }
            .filters { flex-direction: column; }
            .data-table { font-size: 0.95rem; }
            .data-table th, .data-table td { padding: 12px 10px; }
            .btn-group { flex-direction: column; }
            .job-announcement h2 { font-size: 2rem; }
            .job-announcement h3 { font-size: 1.5rem; }
            .job-announcement p, .job-announcement li { font-size: 1.1rem; }
            .profile-header { flex-direction: column; text-align: center; }
            .supervisor-nav { flex-direction: column; }
            .video-container { max-width: 100%; }
            .main-title { font-size: 2.2rem; }
            .sub-title { font-size: 1.2rem; }
            .dashboard-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="lang-ar">
    <button class="lang-toggle" onclick="toggleLanguage()">
        <i class="fas fa-globe"></i>
        <span id="langText">EN</span>
    </button>

    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <div class="video-container">
                <video autoplay muted loop playsinline>
                    <source src="https://res.cloudinary.com/dfgp8dwj3/video/upload/v1761726342/%D8%A7%D9%84%D8%B2%D9%87%D8%B1%D8%A7%D9%86%D9%8A_1_p6ydli.mp4" type="video/mp4">
                    متصفحك لا يدعم تشغيل الفيديو
                </video>
            </div>
            <h1 class="main-title" data-ar="نظام التوظيف" data-en="Employment System" data-ur="ملازمت کا نظام">نظام التوظيف</h1>
            <p class="sub-title" data-ar="Al-Zahrani Logistics - نظام التوظيف" data-en="Al-Zahrani Logistics - Employment System" data-ur="الزہرانی لوجسٹکس - ملازمت کا نظام">Al-Zahrani Logistics - نظام التوظيف</p>
        </div>

        <!-- Navigation Cards -->
        <div class="nav-cards">
            <div class="nav-card" onclick="showJobApplicationForm()">
                <div class="nav-icon"><i class="fas fa-user-tie"></i></div>
                <h3 class="nav-title" data-ar="تقديم طلب توظيف" data-en="Submit Job Application" data-ur="درخواست جمع کروائیں">تقديم طلب توظيف</h3>
                <p class="nav-description" data-ar="تقديم طلب توظيف لوظيفة مندوب توصيل" data-en="Submit job application for delivery representative" data-ur="ڈیلیوری نمائندے کے لیے درخواست جمع کروائیں">تقديم طلب توظيف لوظيفة مندوب توصيل</p>
            </div>

            <div class="nav-card" onclick="showSupervisorLogin()">
                <div class="nav-icon"><i class="fas fa-user-shield"></i></div>
                <h3 class="nav-title" data-ar="دخول المشرف" data-en="Supervisor Login" data-ur="سپروائزر لاگ ان">دخول المشرف</h3>
                <p class="nav-description" data-ar="إدارة طلبات التوظيف وعرض التقارير" data-en="Manage job applications and view reports" data-ur="ملازمت کی درخواستیں منظم کریں اور رپورٹس دیکھیں">إدارة طلبات التوظيف وعرض التقارير</p>
            </div>
        </div>

        <!-- Job Announcement -->
        <div id="jobAnnouncement" class="job-announcement">
            <h2 data-ar="🚀 فرصة عمل مميزة في شركة الزهراني للخدمات اللوجستية 🏍️" data-en="🚀 Great Job Opportunity at Al-Zahrani Logistics Company 🏍️" data-ur="🚀 الزہرانی لوجسٹکس کمپنی میں بہترین ملازمت کا موقع 🏍️">🚀 فرصة عمل مميزة في شركة الزهراني للخدمات اللوجستية 🏍️</h2>
            <p data-ar="تُعلن شركة الزهراني للخدمات اللوجستية عن فتح باب التوظيف لوظيفة مندوب توصيل (دباب نينجا - استور) ضمن فريق ميداني نشط بالمملكة. نبحث عن شباب طموحين وجادين يمتلكون روح الالتزام والمسؤولية ويحبون العمل الميداني والإنجاز السريع." data-en="Al-Zahrani Logistics Company announces the opening of employment for the position of delivery representative (Ninja Motorcycle - Store) within an active field team in the Kingdom. We are looking for ambitious and serious young people who have a spirit of commitment and responsibility and love field work and quick achievement." data-ur="الزہرانی لوجسٹکس کمپنی مملکت میں ایک فعال فیلڈ ٹیم کے اندر ڈیلیوری نمائندے (ننجا موٹرسائیکل - اسٹور) کی پوزیشن کے لیے ملازمت کے دروازے کھولنے کا اعلان کرتی ہے۔ ہم پرعزم اور سنجیدہ نوجوانوں کی تلاش میں ہیں جن میں وابستگی اور ذمہ داری کا جذبہ ہو اور فیلڈ ورک اور فوری کامیابی سے محبت ہو۔">تُعلن شركة الزهراني للخدمات اللوجستية عن فتح باب التوظيف لوظيفة مندوب توصيل (دباب نينجا - استور) ضمن فريق ميداني نشط بالمملكة. نبحث عن شباب طموحين وجادين يمتلكون روح الالتزام والمسؤولية ويحبون العمل الميداني والإنجاز السريع.</p>
            
            <h3 data-ar="تفاصيل الوظيفة" data-en="Job Details" data-ur="ملازمت کی تفصیلات">تفاصيل الوظيفة</h3>
            <ul>
                <li data-ar="المسمى الوظيفي: مندوب توصيل (دباب نينجا - استور)" data-en="Job Title: Delivery Representative (Ninja Motorcycle - Store)" data-ur="ملازمت کا عنوان: ڈیلیوری نمائندہ (ننجا موٹرسائیکل - اسٹور)">المسمى الوظيفي: مندوب توصيل (دباب نينجا - استور)</li>
                <li data-ar="الراتب الشهري: 2300 ريال" data-en="Monthly Salary: 2300 SAR" data-ur="ماہانہ تنخواہ: 2300 ریال">الراتب الشهري: 2300 ريال</li>
                <li data-ar="ساعات الدوام: 10 ساعة يوميًا (اي ساعة اضافية أوفر تايم)" data-en="Working Hours: 10 hours daily (any extra hour is overtime)" data-ur="کام کے اوقات: روزانہ 10 گھنٹے (کوئی بھی اضافی گھنٹہ اوور ٹائم ہے)">ساعات الدوام: 10 ساعة يوميًا (اي ساعة اضافية أوفر تايم)</li>
                <li data-ar="الشركة توفر الدباب والوقود" data-en="The company provides the motorcycle and fuel" data-ur="کمپنی موٹرسائیکل اور ایندھن مہیا کرتی ہے">الشركة توفر الدباب والوقود</li>
                <li data-ar="نقل كفالة بعد شهرين من بدء العمل" data-en="Sponsorship transfer after two months of work" data-ur="کام شروع کرنے کے دو ماہ بعد کفالت کی منتقلی">نقل كفالة بعد شهرين من بدء العمل</li>
                <li data-ar="المكافآت الإضافية - بونس" data-en="Additional rewards - Bonus" data-ur="اضافی انعامات - بونس">المكافآت الإضافية - بونس</li>
            </ul>
            
            <h3 data-ar="الشروط المطلوبة" data-en="Required Conditions" data-ur="مطلوبہ شرائط">الشروط المطلوبة</h3>
            <ul>
                <li data-ar="إقامة سارية المفعول" data-en="Valid residence permit" data-ur="درست رہائشی اجازت">إقامة سارية المفعول</li>
                <li data-ar="رخصة قيادة دباب سارية" data-en="Valid motorcycle driving license" data-ur="درست موٹرسائیکل ڈرائیونگ لائسنس">رخصة قيادة دباب سارية</li>
                <li data-ar="الجدية والانضباط في العمل" data-en="Seriousness and discipline at work" data-ur="کام میں سنجیدگی اور نظم و ضبط">الجدية والانضباط في العمل</li>
            </ul>
            
            <h3 data-ar="المزايا" data-en="Advantages" data-ur="فوائد">المزايا</h3>
            <ul>
                <li data-ar="بيئة عمل منظمة وداعمة" data-en="Organized and supportive work environment" data-ur="منظم اور معاون کام کا ماحول">بيئة عمل منظمة وداعمة</li>
                <li data-ar="فرصة للاستقرار الوظيفي ونقل الكفالة" data-en="Opportunity for job stability and sponsorship transfer" data-ur="ملازمت کے استحکام اور کفالت کی منتقلی کا موقع">فرصة للاستقرار الوظيفي ونقل الكفالة</li>
                <li data-ar="دعم ومتابعة ميدانية مستمرة" data-en="Continuous field support and follow-up" data-ur="مسلسل فیلڈ سپورٹ اور فالو اپ">دعم ومتابعة ميدانية مستمرة</li>
                <li data-ar="مكان العمل: الشرقية – الدمام" data-en="Work Location: Eastern Province - Dammam" data-ur="کام کی جگہ: مشرقی صوبہ - دمام">مكان العمل: الشرقية – الدمام</li>
            </ul>
        </div>

        <!-- Job Application Form -->
        <div id="jobApplicationForm" class="form-container">
            <h2 class="form-title" data-ar="طلب توظيف جديد" data-en="New Job Application" data-ur="نیا ملازمت کا درخواست فارم">طلب توظيف جديد</h2>
            <form id="jobForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-ar="الاسم الكامل" data-en="Full Name" data-ur="پورا نام">الاسم الكامل</label>
                        <input type="text" class="form-input" id="fullName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-ar="رقم الجوال" data-en="Phone Number" data-ur="فون نمبر">رقم الجوال</label>
                        <input type="tel" class="form-input" id="phoneNumber" required>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-ar="نوع المركبة" data-en="Vehicle Type" data-ur="گاڑی کی قسم">نوع المركبة</label>
                        <select class="form-select" id="vehicleType" required onchange="toggleLicensePlateField()">
                            <option value="" data-ar="اختر نوع المركبة" data-en="Select Vehicle Type" data-ur="گاڑی کی قسم منتخب کریں">اختر نوع المركبة</option>
                            <option value="دباب" data-ar="دباب" data-en="Motorcycle" data-ur="موٹرسائیکل">دباب</option>
                            <option value="سيارة" data-ar="سيارة" data-en="Car" data-ur="کار">سيارة</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-ar="رقم لوحة المركبة" data-en="Vehicle Plate Number" data-ur="گاڑی کی پلیٹ نمبر">رقم لوحة المركبة</label>
                        <input type="text" class="form-input" id="vehiclePlate" required>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-ar="تاريخ انتهاء الإقامة" data-en="Residence Expiry Date" data-ur="رہائشی کی میعاد ختم ہونے کی تاریخ">تاريخ انتهاء الإقامة</label>
                        <input type="date" class="form-input" id="residenceExpiry" required onchange="checkExpiry(this, 'residence')">
                        <div class="expiry-info" id="residenceInfo" data-ar="⚠️ يمكن تقديم الطلب حتى مع انتهاء الإقامة" data-en="⚠️ Application can be submitted even with expired residence" data-ur="⚠️ درخواست رہائشی ختم ہونے کے باوجود بھی جمع کرائی جا سکتی ہے">⚠️ يمكن تقديم الطلب حتى مع انتهاء الإقامة</div>
                        <div class="expiry-warning" id="residenceWarning" data-ar="⚠️ إقامتك منتهية - يمكنك تقديم الطلب" data-en="⚠️ Your residence is expired - You can still submit the application" data-ur="⚠️ آپ کی رہائش ختم ہو گئی ہے - آپ پھر بھی درخواست جمع کروا سکتے ہیں">⚠️ إقامتك منتهية - يمكنك تقديم الطلب</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-ar="تاريخ انتهاء الرخصة" data-en="License Expiry Date" data-ur="لائسنس کی میعاد ختم ہونے کی تاریخ">تاريخ انتهاء الرخصة</label>
                        <input type="date" class="form-input" id="licenseExpiry" required onchange="checkExpiry(this, 'license')">
                        <div class="expiry-warning" id="licenseWarning" data-ar="❌ رخصتك منتهية - لا يمكن تقديم الطلب" data-en="❌ Your license is expired - Cannot submit application" data-ur="❌ آپ کا لائسنس ختم ہو گیا ہے - درخواست جمع نہیں کرائی جا سکتی">❌ رخصتك منتهية - لا يمكن تقديم الطلب</div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" data-ar="صورة الإقامة" data-en="Residence Photo" data-ur="رہائشی کی تصویر">صورة الإقامة</label>
                        <input type="file" class="form-input" id="residencePhoto" accept="image/*" onchange="previewImage(this, 'residencePreview')" required>
                        <div class="image-preview" id="residencePreview"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-ar="صورة رخصة القيادة" data-en="Driving License Photo" data-ur="ڈرائیونگ لائسنس کی تصویر">صورة رخصة القيادة</label>
                        <input type="file" class="form-input" id="licensePhoto" accept="image/*" onchange="previewImage(this, 'licensePreview')" required>
                        <div class="image-preview" id="licensePreview"></div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                        <i class="fas fa-paper-plane"></i>
                        <span data-ar="تقديم الطلب" data-en="Submit Application" data-ur="درخواست جمع کروائیں">تقديم الطلب</span>
                    </button>
                </div>
            </form>

            <div class="btn-group">
                <button class="btn btn-secondary btn-full" onclick="showHomePage()">
                    <i class="fas fa-arrow-right"></i>
                    <span data-ar="العودة للرئيسية" data-en="Back to Home" data-ur="ہوم پیج پر واپس جائیں">العودة للرئيسية</span>
                </button>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message">
            <h2 data-ar="شكراً لتقديمك للوظيفة!" data-en="Thank you for applying!" data-ur="درخواست دینے کا شکریہ!">شكراً لتقديمك للوظيفة!</h2>
            <p data-ar="سيتم التواصل معك خلال ساعة او اقل" data-en="We will contact you within an hour or less" data-ur="ہم ایک گھنٹے یا اس سے کم وقت میں آپ سے رابطہ کریں گے">سيتم التواصل معك خلال ساعة او اقل</p>
        </div>

        <!-- Supervisor Login -->
        <div id="supervisorLogin" class="login-container">
            <h2 class="login-title" data-ar="دخول المشرف" data-en="Supervisor Login" data-ur="سپروائزر لاگ ان">دخول المشرف</h2>
            <div class="form-group">
                <label class="form-label" data-ar="اسم المستخدم" data-en="Username" data-ur="صارف نام">اسم المستخدم</label>
                <input type="text" class="form-input" id="username" placeholder="أدخل اسم المستخدم">
            </div>

            <div class="form-group">
                <label class="form-label" data-ar="كلمة المرور" data-en="Password" data-ur="پاس ورڈ">كلمة المرور</label>
                <input type="password" class="form-input" id="password" placeholder="أدخل كلمة المرور">
            </div>

            <div class="btn-group">
                <button class="btn btn-primary btn-full" onclick="supervisorLogin()">
                    <i class="fas fa-sign-in-alt"></i>
                    <span data-ar="دخول" data-en="Login" data-ur="لاگ ان">دخول</span>
                </button>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary btn-full" onclick="showHomePage()">
                    <i class="fas fa-arrow-right"></i>
                    <span data-ar="العودة للرئيسية" data-en="Back to Home" data-ur="ہوم پیج پر واپس جائیں">العودة للرئيسية</span>
                </button>
            </div>
        </div>

        <!-- Verification Container -->
        <div id="verificationContainer" class="verification-container">
            <h2 class="verification-title" data-ar="التحقق من الهوية" data-en="Identity Verification" data-ur="شناختی تصدیق">التحقق من الهوية</h2>
            
            <div class="otp-message" id="otpMessage">
                <i class="fas fa-shield-alt"></i>
                <span data-ar="تم إرسال رمز التحقق إلى المشرف أحمد الصادق" data-en="Verification code has been sent to supervisor Ahmed Al-Sadiq" data-ur="تصدیقی کوڈ سپروائزر احمد الصادق کو بھیج دیا گیا ہے">تم إرسال رمز التحقق إلى المشرف أحمد الصادق</span>
            </div>

            <div class="form-group">
                <label class="form-label" data-ar="أدخل رمز التحقق (OTP)" data-en="Enter Verification Code (OTP)" data-ur="تصدیقی کوڈ درج کریں (OTP)">أدخل رمز التحقق (OTP)</label>
                <input type="password" class="form-input otp-input" id="otpCode" placeholder="●●●●●●" maxlength="6">
            </div>

            <div class="btn-group">
                <button class="btn btn-success btn-full" onclick="verifyOTP()">
                    <i class="fas fa-check-circle"></i>
                    <span data-ar="تحقق" data-en="Verify" data-ur="تصدیق کریں">تحقق</span>
                </button>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary btn-full" onclick="showSupervisorLogin()">
                    <i class="fas fa-arrow-right"></i>
                    <span data-ar="العودة لتسجيل الدخول" data-en="Back to Login" data-ur="لاگ ان پر واپس جائیں">العودة لتسجيل الدخول</span>
                </button>
            </div>
        </div>

        <!-- Supervisor Dashboard -->
        <div id="supervisorDashboard" class="form-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <img src="https://i.ibb.co/vrKBxqC/profile.jpg" alt="Ahmed Al-Sadiq" class="profile-image">
                <div class="profile-info">
                    <h2 class="profile-name" id="currentSupervisorName">أحمد الصادق</h2>
                    <p class="profile-role" id="currentSupervisorRole" data-ar="مشرف نظام التوظيف" data-en="Employment System Supervisor" data-ur="ملازمت کے نظام کا سپروائزر">مشرف نظام التوظيف</p>
                </div>
                <button class="btn btn-danger" onclick="supervisorLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-ar="تسجيل الخروج" data-en="Logout" data-ur="لاگ آؤٹ">تسجيل الخروج</span>
                </button>
            </div>

            <!-- Dashboard Stats -->
            <div id="dashboardStats" class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalApplications">0</div>
                    <div class="stat-label" data-ar="إجمالي الطلبات" data-en="Total Applications" data-ur="کل درخواستیں">إجمالي الطلبات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingApplications">0</div>
                    <div class="stat-label" data-ar="طلبات قيد المراجعة" data-en="Pending Applications" data-ur="زیر التواء درخواستیں">طلبات قيد المراجعة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRepresentatives">0</div>
                    <div class="stat-label" data-ar="إجمالي المندوبين" data-en="Total Representatives" data-ur="کل نمائندے">إجمالي المندوبين</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSupervisors">0</div>
                    <div class="stat-label" data-ar="إجمالي المشرفين" data-en="Total Supervisors" data-ur="کل سپروائزر">إجمالي المشرفين</div>
                </div>
            </div>

            <!-- Supervisor Navigation -->
            <div class="supervisor-nav">
                <button class="btn btn-primary supervisor-nav-btn" onclick="showJobApplicationsSection()">
                    <i class="fas fa-users"></i>
                    <span data-ar="طلبات التوظيف" data-en="Job Applications" data-ur="ملازمت کی درخواستیں">طلبات التوظيف</span>
                </button>
                <button class="btn btn-success supervisor-nav-btn" onclick="showAdvanceRequestsSection()">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span data-ar="طلبات السلفيات" data-en="Advance Requests" data-ur="ایڈوانس کی درخواستیں">طلبات السلفيات</span>
                </button>
                <button class="btn btn-warning supervisor-nav-btn" id="representativesNavBtn" onclick="showRepresentativesSection()">
                    <i class="fas fa-user-tie"></i>
                    <span data-ar="المندوبين" data-en="Representatives" data-ur="نمائندے">المندوبين</span>
                </button>
                <button class="btn btn-danger supervisor-nav-btn" id="adminsNavBtn" onclick="showAdminsSection()">
                    <i class="fas fa-user-shield"></i>
                    <span data-ar="المشرفين" data-en="Supervisors" data-ur="سپروائزر">المشرفين</span>
                </button>
                <button class="btn btn-info supervisor-nav-btn" id="reportsNavBtn" onclick="showReportsSection()">
                    <i class="fas fa-chart-bar"></i>
                    <span data-ar="التقارير" data-en="Reports" data-ur="رپورٹس">التقارير</span>
                </button>
            </div>

            <!-- Job Applications Section -->
            <div id="jobApplicationsSection">
                <div class="table-header">
                    <h2 class="table-title" data-ar="طلبات التوظيف المسجلة" data-en="Registered Job Applications" data-ur="رجسٹرڈ ملازمت کی درخواستیں">طلبات التوظيف المسجلة</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label" data-ar="اسم المتقدم" data-en="Applicant Name" data-ur="درخواست دہندہ کا نام">اسم المتقدم</label>
                            <input type="text" class="form-input" id="filterName" placeholder="بحث بالاسم">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label" data-ar="التاريخ" data-en="Date" data-ur="تاریخ">التاريخ</label>
                            <input type="date" class="form-input" id="filterDate">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label" data-ar="حالة الإقامة" data-en="Residence Status" data-ur="رہائشی کی حالت">حالة الإقامة</label>
                            <select class="form-select" id="filterResidenceStatus">
                                <option value="" data-ar="الكل" data-en="All" data-ur="سب">الكل</option>
                                <option value="active" data-ar="سارية" data-en="Active" data-ur="درست">سارية</option>
                                <option value="expired" data-ar="منتهية" data-en="Expired" data-ur="ختم">منتهية</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="loadJobApplications()" id="loadDataBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span data-ar="عرض البيانات" data-en="Show Data" data-ur="ڈیٹا دکھائیں">عرض البيانات</span>
                    </button>
                    <button class="btn btn-primary" onclick="exportJobApplicationsToExcel()">
                        <i class="fas fa-file-excel"></i>
                        <span data-ar="تحميل Excel" data-en="Download Excel" data-ur="ایکسل ڈاؤن لوڈ کریں">تحميل Excel</span>
                    </button>
                </div>

                <div class="table-container mt-20">
                    <table class="data-table" id="jobApplicationsTable">
                        <thead>
                            <tr>
                                <th data-ar="الاسم" data-en="Name" data-ur="نام">الاسم</th>
                                <th data-ar="رقم الجوال" data-en="Phone" data-ur="فون">رقم الجوال</th>
                                <th data-ar="نوع المركبة" data-en="Vehicle Type" data-ur="گاڑی کی قسم">نوع المركبة</th>
                                <th data-ar="رقم اللوحة" data-en="Plate Number" data-ur="پلیٹ نمبر">رقم اللوحة</th>
                                <th data-ar="انتهاء الإقامة" data-en="Residence Expiry" data-ur="رہائشی کی میعاد">انتهاء الإقامة</th>
                                <th data-ar="حالة الإقامة" data-en="Residence Status" data-ur="رہائشی کی حالت">حالة الإقامة</th>
                                <th data-ar="انتهاء الرخصة" data-en="License Expiry" data-ur="لائسنس کی میعاد">انتهاء الرخصة</th>
                                <th data-ar="حالة الرخصة" data-en="License Status" data-ur="لائسنس کی حالت">حالة الرخصة</th>
                                <th data-ar="صورة الإقامة" data-en="Residence Photo" data-ur="رہائشی تصویر">صورة الإقامة</th>
                                <th data-ar="صورة الرخصة" data-en="License Photo" data-ur="لائسنس تصویر">صورة الرخصة</th>
                                <th data-ar="التاريخ" data-en="Date" data-ur="تاریخ">التاريخ</th>
                                <th data-ar="الإجراءات" data-en="Actions" data-ur="اعمال">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                            <!-- البيانات سيتم تحميلها هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Advance Requests Section -->
            <div id="advanceRequestsSection" style="display: none;">
                <div class="table-header">
                    <h2 class="table-title" data-ar="طلبات السلفيات" data-en="Advance Requests" data-ur="ایڈوانس کی درخواستیں">طلبات السلفيات</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label" data-ar="اسم الموظف" data-en="Employee Name" data-ur="ملازم کا نام">اسم الموظف</label>
                            <input type="text" class="form-input" id="filterEmployeeName" placeholder="بحث بالاسم">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label" data-ar="التاريخ" data-en="Date" data-ur="تاریخ">التاريخ</label>
                            <input type="date" class="form-input" id="filterAdvanceDate">
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="loadAdvanceRequests()" id="loadAdvanceDataBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span data-ar="عرض البيانات" data-en="Show Data" data-ur="ڈیٹا دکھائیں">عرض البيانات</span>
                    </button>
                    <button class="btn btn-primary" onclick="exportAdvanceRequestsToExcel()">
                        <i class="fas fa-file-excel"></i>
                        <span data-ar="تحميل Excel" data-en="Download Excel" data-ur="ایکسل ڈاؤن لوڈ کریں">تحميل Excel</span>
                    </button>
                    <button class="btn btn-warning" onclick="showAddAdvanceRequestForm()">
                        <i class="fas fa-plus"></i>
                        <span data-ar="إضافة طلب سلفية" data-en="Add Advance Request" data-ur="ایڈوانس کی درخواست شامل کریں">إضافة طلب سلفية</span>
                    </button>
                </div>

                <div class="table-container mt-20">
                    <table class="data-table" id="advanceRequestsTable">
                        <thead>
                            <tr>
                                <th data-ar="الاسم" data-en="Name" data-ur="نام">الاسم</th>
                                <th data-ar="المشروع" data-en="Project" data-ur="پروجیکٹ">المشروع</th>
                                <th data-ar="رقم الإقامة" data-en="Residence Number" data-ur="رہائشی نمبر">رقم الإقامة</th>
                                <th data-ar="نوع المركبة" data-en="Vehicle Type" data-ur="گاڑی کی قسم">نوع المركبة</th>
                                <th data-ar="رقم لوحة الدباب" data-en="Motorcycle Plate" data-ur="موٹرسائیکل پلیٹ">رقم لوحة الدباب</th>
                                <th data-ar="رقم لوحة السيارة" data-en="Car Plate" data-ur="کار پلیٹ">رقم لوحة السيارة</th>
                                <th data-ar="المبلغ" data-en="Amount" data-ur="رقم">المبلغ</th>
                                <th data-ar="التاريخ" data-en="Date" data-ur="تاریخ">التاريخ</th>
                                <th data-ar="الحالة" data-en="Status" data-ur="حالت">الحالة</th>
                                <th data-ar="الإجراءات" data-en="Actions" data-ur="اعمال">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="advanceRequestsTableBody">
                            <!-- البيانات سيتم تحميلها هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Representatives Section -->
            <div id="representativesSection" style="display: none;">
                <div class="table-header">
                    <h2 class="table-title" data-ar="إدارة المندوبين" data-en="Representatives Management" data-ur="نمائندوں کا انتظام">إدارة المندوبين</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label" data-ar="اسم المندوب" data-en="Representative Name" data-ur="نمائندہ کا نام">اسم المندوب</label>
                            <input type="text" class="form-input" id="filterRepresentativeName" placeholder="بحث بالاسم">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label" data-ar="المنطقة" data-en="Region" data-ur="علاقہ">المنطقة</label>
                            <input type="text" class="form-input" id="filterRepresentativeRegion" placeholder="بحث بالمنطقة">
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="loadRepresentatives()" id="loadRepresentativesBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span data-ar="عرض البيانات" data-en="Show Data" data-ur="ڈیٹا دکھائیں">عرض البيانات</span>
                    </button>
                    <button class="btn btn-primary" onclick="exportRepresentativesToExcel()">
                        <i class="fas fa-file-excel"></i>
                        <span data-ar="تحميل Excel" data-en="Download Excel" data-ur="ایکسل ڈاؤن لوڈ کریں">تحميل Excel</span>
                    </button>
                    <button class="btn btn-warning" onclick="showAddRepresentativeForm()">
                        <i class="fas fa-plus"></i>
                        <span data-ar="إضافة مندوب جديد" data-en="Add New Representative" data-ur="نیا نمائندہ شامل کریں">إضافة مندوب جديد</span>
                    </button>
                </div>

                <div class="table-container mt-20">
                    <table class="data-table" id="representativesTable">
                        <thead>
                            <tr>
                                <th data-ar="الاسم" data-en="Name" data-ur="نام">الاسم</th>
                                <th data-ar="رقم الهوية/الإقامة" data-en="ID/Residence Number" data-ur="آئی ڈی/رہائشی نمبر">رقم الهوية/الإقامة</th>
                                <th data-ar="رقم الهاتف" data-en="Phone Number" data-ur="فون نمبر">رقم الهاتف</th>
                                <th data-ar="رقم الإقامة" data-en="Residence Number" data-ur="رہائشی نمبر">رقم الإقامة</th>
                                <th data-ar="المنطقة" data-en="Region" data-ur="علاقہ">المنطقة</th>
                                <th data-ar="نوع المركبة" data-en="Vehicle Type" data-ur="گاڑی کی قسم">نوع المركبة</th>
                                <th data-ar="رقم اللوحة" data-en="Plate Number" data-ur="پلیٹ نمبر">رقم اللوحة</th>
                                <th data-ar="نوع السيارة" data-en="Car Type" data-ur="کار کی قسم">نوع السيارة</th>
                                <th data-ar="التاريخ" data-en="Date" data-ur="تاریخ">التاريخ</th>
                                <th data-ar="الإجراءات" data-en="Actions" data-ur="اعمال">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="representativesTableBody">
                            <!-- البيانات سيتم تحميلها هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admins Section -->
            <div id="adminsSection" style="display: none;">
                <div class="table-header">
                    <h2 class="table-title" data-ar="إدارة المشرفين" data-en="Supervisors Management" data-ur="سپروائزر کا انتظام">إدارة المشرفين</h2>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="loadSupervisors()" id="loadSupervisorsBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span data-ar="عرض البيانات" data-en="Show Data" data-ur="ڈیٹا دکھائیں">عرض البيانات</span>
                    </button>
                    <button class="btn btn-warning" onclick="showAddSupervisorForm()">
                        <i class="fas fa-plus"></i>
                        <span data-ar="إضافة مشرف جديد" data-en="Add New Supervisor" data-ur="نیا سپروائزر شامل کریں">إضافة مشرف جديد</span>
                    </button>
                </div>

                <div class="table-container mt-20">
                    <table class="data-table" id="supervisorsTable">
                        <thead>
                            <tr>
                                <th data-ar="الاسم الكامل" data-en="Full Name" data-ur="پورا نام">الاسم الكامل</th>
                                <th data-ar="اسم المستخدم" data-en="Username" data-ur="صارف نام">اسم المستخدم</th>
                                <th data-ar="الصلاحيات" data-en="Permissions" data-ur="اجازتیں">الصلاحيات</th>
                                <th data-ar="تاريخ الإضافة" data-en="Added Date" data-ur="شامل کرنے کی تاریخ">تاريخ الإضافة</th>
                                <th data-ar="الإجراءات" data-en="Actions" data-ur="اعمال">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="supervisorsTableBody">
                            <!-- البيانات سيتم تحميلها هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" style="display: none;">
                <div class="table-header">
                    <h2 class="table-title" data-ar="التقارير والإحصائيات" data-en="Reports and Statistics" data-ur="رپورٹس اور اعداد و شمار">التقارير والإحصائيات</h2>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="reportTotalApplications">0</div>
                        <div class="stat-label" data-ar="إجمالي طلبات التوظيف" data-en="Total Job Applications" data-ur="کل ملازمت کی درخواستیں">إجمالي طلبات التوظيف</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reportActiveRepresentatives">0</div>
                        <div class="stat-label" data-ar="المندوبين النشطين" data-en="Active Representatives" data-ur="فعال نمائندے">المندوبين النشطين</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reportPendingAdvances">0</div>
                        <div class="stat-label" data-ar="طلبات السلفيات المعلقة" data-en="Pending Advance Requests" data-ur="زیر التواء ایڈوانس کی درخواستیں">طلبات السلفيات المعلقة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="reportTotalSupervisors">0</div>
                        <div class="stat-label" data-ar="إجمالي المشرفين" data-en="Total Supervisors" data-ur="کل سپروائزر">إجمالي المشرفين</div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateReports()">
                        <i class="fas fa-chart-line"></i>
                        <span data-ar="تحديث التقارير" data-en="Refresh Reports" data-ur="رپورٹس تازہ کریں">تحديث التقارير</span>
                    </button>
                    <button class="btn btn-success" onclick="exportReportsToExcel()">
                        <i class="fas fa-file-excel"></i>
                        <span data-ar="تصدير التقارير" data-en="Export Reports" data-ur="رپورٹس برآمد کریں">تصدير التقارير</span>
                    </button>
                </div>
            </div>

            <!-- Add Advance Request Form -->
            <div id="addAdvanceRequestForm" class="form-container" style="display: none;">
                <h2 class="form-title" data-ar="إضافة طلب سلفية جديد" data-en="Add New Advance Request" data-ur="نیا ایڈوانس کی درخواست شامل کریں">إضافة طلب سلفية جديد</h2>
                <form id="advanceRequestForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="اسم الموظف" data-en="Employee Name" data-ur="ملازم کا نام">اسم الموظف</label>
                            <input type="text" class="form-input" id="employeeName" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="المشروع" data-en="Project" data-ur="پروجیکٹ">المشروع</label>
                            <input type="text" class="form-input" id="project" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="رقم الإقامة" data-en="Residence Number" data-ur="رہائشی نمبر">رقم الإقامة</label>
                            <input type="text" class="form-input" id="residenceNumber" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="المبلغ" data-en="Amount" data-ur="رقم">المبلغ</label>
                            <input type="number" class="form-input" id="advanceAmount" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="نوع المركبة" data-en="Vehicle Type" data-ur="گاڑی کی قسم">نوع المركبة</label>
                            <select class="form-select" id="advanceVehicleType" required onchange="toggleAdvancePlateFields()">
                                <option value="" data-ar="اختر نوع المركبة" data-en="Select Vehicle Type" data-ur="گاڑی کی قسم منتخب کریں">اختر نوع المركبة</option>
                                <option value="دباب" data-ar="دباب" data-en="Motorcycle" data-ur="موٹرسائیکل">دباب</option>
                                <option value="سيارة" data-ar="سيارة" data-en="Car" data-ur="کار">سيارة</option>
                                <option value="كلاهما" data-ar="كلاهما" data-en="Both" data-ur="دونوں">كلاهما</option>
                            </select>
                        </div>

                        <div class="form-group" id="motorcyclePlateGroup">
                            <label class="form-label" data-ar="رقم لوحة الدباب" data-en="Motorcycle Plate" data-ur="موٹرسائیکل پلیٹ">رقم لوحة الدباب</label>
                            <input type="text" class="form-input" id="motorcyclePlate">
                        </div>

                        <div class="form-group" id="carPlateGroup" style="display: none;">
                            <label class="form-label" data-ar="رقم لوحة السيارة" data-en="Car Plate" data-ur="کار پلیٹ">رقم لوحة السيارة</label>
                            <input type="text" class="form-input" id="carPlate">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary btn-full" id="submitAdvanceBtn">
                            <i class="fas fa-save"></i>
                            <span data-ar="حفظ طلب السلفية" data-en="Save Advance Request" data-ur="ایڈوانس کی درخواست محفوظ کریں">حفظ طلب السلفية</span>
                        </button>
                    </div>
                </form>

                <div class="btn-group">
                    <button class="btn btn-secondary btn-full" onclick="showAdvanceRequestsSection()">
                        <i class="fas fa-arrow-right"></i>
                        <span data-ar="العودة لطلبات السلفيات" data-en="Back to Advance Requests" data-ur="ایڈوانس کی درخواستوں پر واپس جائیں">العودة لطلبات السلفيات</span>
                    </button>
                </div>
            </div>

            <!-- Add Representative Form -->
            <div id="addRepresentativeForm" class="form-container" style="display: none;">
                <h2 class="form-title" data-ar="إضافة مندوب جديد" data-en="Add New Representative" data-ur="نیا نمائندہ شامل کریں">إضافة مندوب جديد</h2>
                <form id="representativeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="الاسم الكامل" data-en="Full Name" data-ur="پورا نام">الاسم الكامل</label>
                            <input type="text" class="form-input" id="representativeName" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="رقم الهوية / الإقامة" data-en="ID / Residence Number" data-ur="آئی ڈی / رہائشی نمبر">رقم الهوية / الإقامة</label>
                            <input type="text" class="form-input" id="representativeId" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="رقم الهاتف" data-en="Phone Number" data-ur="فون نمبر">رقم الهاتف</label>
                            <input type="tel" class="form-input" id="representativePhone" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="رقم الإقامة" data-en="Residence Number" data-ur="رہائشی نمبر">رقم الإقامة</label>
                            <input type="text" class="form-input" id="representativeResidenceNumber" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="المنطقة" data-en="Region" data-ur="علاقہ">المنطقة</label>
                            <input type="text" class="form-input" id="representativeRegion" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="نوع المركبة" data-en="Vehicle Type" data-ur="گاڑی کی قسم">نوع المركبة</label>
                            <select class="form-select" id="representativeVehicleType" required onchange="toggleRepresentativeVehicleFields()">
                                <option value="" data-ar="اختر نوع المركبة" data-en="Select Vehicle Type" data-ur="گاڑی کی قسم منتخب کریں">اختر نوع المركبة</option>
                                <option value="دباب" data-ar="دباب" data-en="Motorcycle" data-ur="موٹرسائیکل">دباب</option>
                                <option value="سيارة" data-ar="سيارة" data-en="Car" data-ur="کار">سيارة</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="رقم اللوحة" data-en="Plate Number" data-ur="پلیٹ نمبر">رقم اللوحة</label>
                            <input type="text" class="form-input" id="representativePlate" required>
                        </div>

                        <div class="form-group" id="representativeCarTypeGroup" style="display: none;">
                            <label class="form-label" data-ar="نوع السيارة" data-en="Car Type" data-ur="کار کی قسم">نوع السيارة</label>
                            <input type="text" class="form-input" id="representativeCarType">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary btn-full" id="submitRepresentativeBtn">
                            <i class="fas fa-save"></i>
                            <span data-ar="حفظ بيانات المندوب" data-en="Save Representative Data" data-ur="نمائندہ کا ڈیٹا محفوظ کریں">حفظ بيانات المندوب</span>
                        </button>
                    </div>
                </form>

                <div class="btn-group">
                    <button class="btn btn-secondary btn-full" onclick="showRepresentativesSection()">
                        <i class="fas fa-arrow-right"></i>
                        <span data-ar="العودة للمندوبين" data-en="Back to Representatives" data-ur="نمائندوں پر واپس جائیں">العودة للمندوبين</span>
                    </button>
                </div>
            </div>

            <!-- Add Supervisor Form -->
            <div id="addSupervisorForm" class="form-container" style="display: none;">
                <h2 class="form-title" data-ar="إضافة مشرف جديد" data-en="Add New Supervisor" data-ur="نیا سپروائزر شامل کریں">إضافة مشرف جديد</h2>
                <form id="supervisorForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="الاسم الكامل" data-en="Full Name" data-ur="پورا نام">الاسم الكامل</label>
                            <input type="text" class="form-input" id="supervisorFullName" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="اسم المستخدم" data-en="Username" data-ur="صارف نام">اسم المستخدم</label>
                            <input type="text" class="form-input" id="supervisorUsername" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-ar="كلمة المرور" data-en="Password" data-ur="پاس ورڈ">كلمة المرور</label>
                            <input type="password" class="form-input" id="supervisorPassword" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-ar="تأكيد كلمة المرور" data-en="Confirm Password" data-ur="پاس ورڈ کی تصدیق کریں">تأكيد كلمة المرور</label>
                            <input type="password" class="form-input" id="supervisorConfirmPassword" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-ar="صلاحيات الوصول" data-en="Access Permissions" data-ur="رسائی کی اجازتیں">صلاحيات الوصول</label>
                        
                        <div class="permission-checkbox">
                            <input type="checkbox" id="permissionJobApps" checked>
                            <label for="permissionJobApps" data-ar="إدارة طلبات التوظيف" data-en="Manage Job Applications" data-ur="ملازمت کی درخواستیں منظم کریں">إدارة طلبات التوظيف</label>
                        </div>
                        
                        <div class="permission-checkbox">
                            <input type="checkbox" id="permissionAdvances" checked>
                            <label for="permissionAdvances" data-ar="إدارة طلبات السلفيات" data-en="Manage Advance Requests" data-ur="ایڈوانس کی درخواستیں منظم کریں">إدارة طلبات السلفيات</label>
                        </div>
                        
                        <div class="permission-checkbox">
                            <input type="checkbox" id="permissionRepresentatives">
                            <label for="permissionRepresentatives" data-ar="إدارة المندوبين" data-en="Manage Representatives" data-ur="نمائندوں کا انتظام">إدارة المندوبين</label>
                        </div>
                        
                        <div class="permission-checkbox">
                            <input type="checkbox" id="permissionAdmins">
                            <label for="permissionAdmins" data-ar="إدارة المشرفين" data-en="Manage Supervisors" data-ur="سپروائزر کا انتظام">إدارة المشرفين</label>
                        </div>
                        
                        <div class="permission-checkbox">
                            <input type="checkbox" id="permissionReports">
                            <label for="permissionReports" data-ar="عرض التقارير" data-en="View Reports" data-ur="رپورٹس دیکھیں">عرض التقارير</label>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary btn-full" id="submitSupervisorBtn">
                            <i class="fas fa-save"></i>
                            <span data-ar="حفظ بيانات المشرف" data-en="Save Supervisor Data" data-ur="سپروائزر کا ڈیٹا محفوظ کریں">حفظ بيانات المشرف</span>
                        </button>
                    </div>
                </form>

                <div class="btn-group">
                    <button class="btn btn-secondary btn-full" onclick="showAdminsSection()">
                        <i class="fas fa-arrow-right"></i>
                        <span data-ar="العودة للمشرفين" data-en="Back to Supervisors" data-ur="سپروائزر پر واپس جائیں">العودة للمشرفين</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let systemState = {
            firebaseReady: false,
            currentEditingId: null,
            selectedResidenceImage: null,
            selectedLicenseImage: null,
            hasExpiredResidence: false,
            hasExpiredLicense: false,
            verificationCode: "046035",
            currentSupervisor: null,
            currentPermissions: {
                jobApps: true,
                advances: true,
                representatives: false,
                admins: false,
                reports: false
            }
        };

        window.onFirebaseReady = function() {
            systemState.firebaseReady = true;
            console.log("✅ Firebase is ready to use");
            showNotification(getTranslation('✅ تم الاتصال بقاعدة البيانات بنجاح', '✅ Connected to database successfully', '✅ ڈیٹا بیس سے کامیابی سے منسلک ہو گیا'), 'success');
            
            // تحميل الإحصائيات عند الاتصال
            if (systemState.currentSupervisor) {
                loadDashboardStats();
            }
        };

        // دالة التحقق من تاريخ الانتهاء
        function checkExpiry(input, type) {
            const expiryDate = new Date(input.value);
            const today = new Date();
            const warningElement = document.getElementById(type + 'Warning');
            const infoElement = document.getElementById(type + 'Info');
            
            if (expiryDate < today) {
                if (type === 'residence') {
                    // للإقامة: إظهار رسالة تنبيه ولكن السماح بالتقديم
                    warningElement.style.display = 'block';
                    infoElement.style.display = 'none';
                    systemState.hasExpiredResidence = true;
                } else {
                    // للرخصة: منع التقديم
                    warningElement.style.display = 'block';
                    systemState.hasExpiredLicense = true;
                }
            } else {
                warningElement.style.display = 'none';
                if (type === 'residence') {
                    infoElement.style.display = 'block';
                    systemState.hasExpiredResidence = false;
                } else {
                    systemState.hasExpiredLicense = false;
                }
            }
        }

        // دالة رفع الصور إلى ImgBB
        async function uploadToImgBB(imageFile) {
            const apiKey = '6724dafff610326aa1f9cd661d600c9f';
            const formData = new FormData();
            formData.append('image', imageFile);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error(data.error.message || 'فشل رفع الصورة');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-image';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i> ' + getTranslation('إزالة الصورة', 'Remove Image', 'تصویر ہٹائیں');
                    removeBtn.onclick = function() {
                        input.value = '';
                        preview.innerHTML = '';
                        if (previewId === 'residencePreview') {
                            systemState.selectedResidenceImage = null;
                        } else if (previewId === 'licensePreview') {
                            systemState.selectedLicenseImage = null;
                        }
                    };
                    
                    preview.appendChild(img);
                    preview.appendChild(removeBtn);
                    
                    if (previewId === 'residencePreview') {
                        systemState.selectedResidenceImage = input.files[0];
                    } else if (previewId === 'licensePreview') {
                        systemState.selectedLicenseImage = input.files[0];
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleLicensePlateField() {
            const vehicleType = document.getElementById('vehicleType').value;
            const vehiclePlate = document.getElementById('vehiclePlate');
            
            if (vehicleType === 'دباب') {
                vehiclePlate.placeholder = getTranslation('أدخل رقم لوحة الدباب', 'Enter motorcycle plate number', 'موٹرسائیکل پلیٹ نمبر درج کریں');
            } else if (vehicleType === 'سيارة') {
                vehiclePlate.placeholder = getTranslation('أدخل رقم لوحة السيارة', 'Enter car plate number', 'کار پلیٹ نمبر درج کریں');
            } else {
                vehiclePlate.placeholder = getTranslation('رقم لوحة المركبة', 'Vehicle plate number', 'گاڑی کی پلیٹ نمبر');
            }
        }

        function toggleAdvancePlateFields() {
            const vehicleType = document.getElementById('advanceVehicleType').value;
            const motorcycleGroup = document.getElementById('motorcyclePlateGroup');
            const carGroup = document.getElementById('carPlateGroup');
            
            if (vehicleType === 'دباب') {
                motorcycleGroup.style.display = 'block';
                carGroup.style.display = 'none';
                document.getElementById('motorcyclePlate').required = true;
                document.getElementById('carPlate').required = false;
            } else if (vehicleType === 'سيارة') {
                motorcycleGroup.style.display = 'none';
                carGroup.style.display = 'block';
                document.getElementById('motorcyclePlate').required = false;
                document.getElementById('carPlate').required = true;
            } else if (vehicleType === 'كلاهما') {
                motorcycleGroup.style.display = 'block';
                carGroup.style.display = 'block';
                document.getElementById('motorcyclePlate').required = true;
                document.getElementById('carPlate').required = true;
            } else {
                motorcycleGroup.style.display = 'none';
                carGroup.style.display = 'none';
                document.getElementById('motorcyclePlate').required = false;
                document.getElementById('carPlate').required = false;
            }
        }

        function toggleRepresentativeVehicleFields() {
            const vehicleType = document.getElementById('representativeVehicleType').value;
            const carTypeGroup = document.getElementById('representativeCarTypeGroup');
            
            if (vehicleType === 'سيارة') {
                carTypeGroup.style.display = 'block';
                document.getElementById('representativeCarType').required = true;
            } else {
                carTypeGroup.style.display = 'none';
                document.getElementById('representativeCarType').required = false;
            }
        }

        function showHomePage() {
            document.getElementById('jobApplicationForm').style.display = 'none';
            document.getElementById('supervisorLogin').style.display = 'none';
            document.getElementById('supervisorDashboard').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('verificationContainer').style.display = 'none';
            document.querySelector('.nav-cards').style.display = 'grid';
            document.getElementById('jobAnnouncement').style.display = 'block';
            resetForm();
        }

        function showJobApplicationForm() {
            document.querySelector('.nav-cards').style.display = 'none';
            document.getElementById('jobApplicationForm').style.display = 'block';
            document.getElementById('supervisorLogin').style.display = 'none';
            document.getElementById('supervisorDashboard').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('verificationContainer').style.display = 'none';
            document.getElementById('jobAnnouncement').style.display = 'none';
            resetForm();
        }

        function showSupervisorLogin() {
            document.querySelector('.nav-cards').style.display = 'none';
            document.getElementById('jobApplicationForm').style.display = 'none';
            document.getElementById('supervisorLogin').style.display = 'block';
            document.getElementById('supervisorDashboard').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('verificationContainer').style.display = 'none';
            document.getElementById('jobAnnouncement').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showVerificationContainer() {
            document.querySelector('.nav-cards').style.display = 'none';
            document.getElementById('jobApplicationForm').style.display = 'none';
            document.getElementById('supervisorLogin').style.display = 'none';
            document.getElementById('supervisorDashboard').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('verificationContainer').style.display = 'block';
            document.getElementById('jobAnnouncement').style.display = 'none';
            document.getElementById('otpCode').value = '';
        }

        function showSupervisorDashboard() {
            document.querySelector('.nav-cards').style.display = 'none';
            document.getElementById('jobApplicationForm').style.display = 'none';
            document.getElementById('supervisorLogin').style.display = 'none';
            document.getElementById('supervisorDashboard').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('verificationContainer').style.display = 'none';
            document.getElementById('jobAnnouncement').style.display = 'none';
            
            // تحديث واجهة المستخدم بناءً على الصلاحيات
            updateUIByPermissions();
            
            showJobApplicationsSection();
            loadDashboardStats();
        }

        function showJobApplicationsSection() {
            document.getElementById('jobApplicationsSection').style.display = 'block';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'none';
            loadJobApplications();
        }

        function showAdvanceRequestsSection() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'block';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'none';
            loadAdvanceRequests();
        }

        function showRepresentativesSection() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'block';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'none';
            loadRepresentatives();
        }

        function showAdminsSection() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'block';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'none';
            loadSupervisors();
        }

        function showReportsSection() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'block';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'none';
            generateReports();
        }

        function showAddAdvanceRequestForm() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'block';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'none';
            document.getElementById('advanceRequestForm').reset();
        }

        function showAddRepresentativeForm() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'block';
            document.getElementById('addSupervisorForm').style.display = 'none';
            document.getElementById('representativeForm').reset();
        }

        function showAddSupervisorForm() {
            document.getElementById('jobApplicationsSection').style.display = 'none';
            document.getElementById('advanceRequestsSection').style.display = 'none';
            document.getElementById('representativesSection').style.display = 'none';
            document.getElementById('adminsSection').style.display = 'none';
            document.getElementById('reportsSection').style.display = 'none';
            document.getElementById('addAdvanceRequestForm').style.display = 'none';
            document.getElementById('addRepresentativeForm').style.display = 'none';
            document.getElementById('addSupervisorForm').style.display = 'block';
            document.getElementById('supervisorForm').reset();
        }

        function showSuccessMessage() {
            document.querySelector('.nav-cards').style.display = 'none';
            document.getElementById('jobApplicationForm').style.display = 'none';
            document.getElementById('supervisorLogin').style.display = 'none';
            document.getElementById('supervisorDashboard').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('jobAnnouncement').style.display = 'none';
        }

        function resetForm() {
            document.getElementById('jobForm').reset();
            document.getElementById('residencePreview').innerHTML = '';
            document.getElementById('licensePreview').innerHTML = '';
            document.getElementById('residenceWarning').style.display = 'none';
            document.getElementById('licenseWarning').style.display = 'none';
            document.getElementById('residenceInfo').style.display = 'block';
            systemState.currentEditingId = null;
            systemState.selectedResidenceImage = null;
            systemState.selectedLicenseImage = null;
            systemState.hasExpiredResidence = false;
            systemState.hasExpiredLicense = false;
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span data-ar="تقديم الطلب" data-en="Submit Application" data-ur="درخواست جمع کروائیں">تقديم الطلب</span>';
            submitBtn.disabled = false;
        }

        async function supervisorLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showNotification(getTranslation('❌ يرجى إدخال اسم المستخدم وكلمة المرور', '❌ Please enter username and password', '❌ براہ کرم صارف نام اور پاس ورڈ درج کریں'), 'error');
                return;
            }

            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            try {
                const q = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, "supervisors"),
                    window.firestoreFunctions.where("username", "==", username)
                );
                
                const querySnapshot = await window.firestoreFunctions.getDocs(q);
                
                if (querySnapshot.empty) {
                    showNotification(getTranslation('❌ اسم المستخدم غير صحيح', '❌ Invalid username', '❌ غلط صارف نام'), 'error');
                    return;
                }

                let supervisorFound = false;
                querySnapshot.forEach((doc) => {
                    const supervisorData = doc.data();
                    if (supervisorData.password === password) {
                        supervisorFound = true;
                        systemState.currentSupervisor = {
                            id: doc.id,
                            ...supervisorData
                        };
                        
                        // حفظ الصلاحيات في حالة النظام
                        systemState.currentPermissions = supervisorData.permissions || {
                            jobApps: true,
                            advances: true,
                            representatives: false,
                            admins: false,
                            reports: false
                        };
                        
                        // تحديث واجهة المستخدم
                        document.getElementById('currentSupervisorName').textContent = supervisorData.fullName;
                        document.getElementById('currentSupervisorRole').textContent = getTranslation('مشرف نظام التوظيف', 'Employment System Supervisor', 'ملازمت کے نظام کا سپروائزر');
                    }
                });

                if (supervisorFound) {
                    showSupervisorDashboard();
                    showNotification(getTranslation('✅ تم تسجيل الدخول بنجاح', '✅ Login successful', '✅ لاگ ان کامیاب'), 'success');
                } else {
                    showNotification(getTranslation('❌ كلمة المرور غير صحيحة', '❌ Invalid password', '❌ غلط پاس ورڈ'), 'error');
                }
            } catch (error) {
                console.error('Error during login:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تسجيل الدخول', '❌ Error during login', '❌ لاگ ان کے دوران خرابی'), 'error');
            }
        }

        function verifyOTP() {
            const otpCode = document.getElementById('otpCode').value;
            
            if (otpCode === systemState.verificationCode) {
                showSupervisorDashboard();
                showNotification(getTranslation('✅ تم التحقق من الهوية - المشرف أحمد الصادق', '✅ Identity verified - Supervisor Ahmed Al-Sadiq', '✅ شناخت کی تصدیق ہو گئی - سپروائزر احمد الصادق'), 'success');
            } else {
                showNotification(getTranslation('❌ رمز التحقق غير صحيح', '❌ Invalid verification code', '❌ غلط تصدیقی کوڈ'), 'error');
            }
        }

        function supervisorLogout() {
            systemState.currentSupervisor = null;
            systemState.currentPermissions = {
                jobApps: true,
                advances: true,
                representatives: false,
                admins: false,
                reports: false
            };
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('otpCode').value = '';
            showHomePage();
            showNotification(getTranslation('تم تسجيل الخروج', 'Logged out successfully', 'لاگ آؤٹ کامیاب'), 'info');
        }

        function updateUIByPermissions() {
            const permissions = systemState.currentPermissions;
            
            // إخفاء/إظهار أزرار التنقل بناءً على الصلاحيات
            document.getElementById('representativesNavBtn').style.display = permissions.representatives ? 'flex' : 'none';
            document.getElementById('adminsNavBtn').style.display = permissions.admins ? 'flex' : 'none';
            document.getElementById('reportsNavBtn').style.display = permissions.reports ? 'flex' : 'none';
        }

        async function loadDashboardStats() {
            if (!systemState.firebaseReady) return;

            try {
                // تحميل إحصائيات طلبات التوظيف
                const jobAppsSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "jobApplications")
                );
                document.getElementById('totalApplications').textContent = jobAppsSnapshot.size;
                
                // تحميل إحصائيات المندوبين
                const repsSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "representatives")
                );
                document.getElementById('totalRepresentatives').textContent = repsSnapshot.size;
                
                // تحميل إحصائيات المشرفين
                const supervisorsSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "supervisors")
                );
                document.getElementById('totalSupervisors').textContent = supervisorsSnapshot.size;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function submitJobApplication(event) {
            event.preventDefault();
            
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            // التحقق من صلاحية الرخصة فقط (الإقامة مسموح بها حتى لو منتهية)
            if (systemState.hasExpiredLicense) {
                showNotification(getTranslation('❌ لا يمكن تقديم الطلب - رخصتك منتهية', '❌ Cannot submit application - Your license is expired', '❌ درخواست جمع نہیں کرائی جا سکتی - آپ کا لائسنس ختم ہو گیا ہے'), 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري الإرسال...', 'Submitting...', 'جمع کرایا جا رہا ہے...');
                submitBtn.disabled = true;

                const formData = {
                    fullName: document.getElementById('fullName').value.trim(),
                    phoneNumber: document.getElementById('phoneNumber').value.trim(),
                    vehicleType: document.getElementById('vehicleType').value,
                    vehiclePlate: document.getElementById('vehiclePlate').value.trim(),
                    residenceExpiry: document.getElementById('residenceExpiry').value,
                    licenseExpiry: document.getElementById('licenseExpiry').value,
                    residenceStatus: systemState.hasExpiredResidence ? 'expired' : 'active',
                    licenseStatus: systemState.hasExpiredLicense ? 'expired' : 'active',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date(),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                if (!formData.fullName || !formData.phoneNumber || !formData.residenceExpiry || !formData.licenseExpiry || !formData.vehicleType || !formData.vehiclePlate) {
                    showNotification(getTranslation('❌ يرجى ملء جميع الحقول المطلوبة', '❌ Please fill all required fields', '❌ براہ کرم تمام ضروری فیلڈز کو پُر کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // التحقق من وجود الصور
                if (!systemState.selectedResidenceImage || !systemState.selectedLicenseImage) {
                    showNotification(getTranslation('❌ يرجى رفع صورتي الإقامة والرخصة', '❌ Please upload both residence and license photos', '❌ براہ کرم رہائشی اور لائسنس دونوں تصاویر اپ لوڈ کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                let residenceImageUrl = null;
                let licenseImageUrl = null;

                // رفع صورة الإقامة
                try {
                    showNotification(getTranslation('📸 جاري رفع صورة الإقامة...', '📸 Uploading residence photo...', '📸 رہائشی تصویر اپ لوڈ ہو رہی ہے...'), 'info');
                    residenceImageUrl = await uploadToImgBB(systemState.selectedResidenceImage);
                    formData.residenceImageUrl = residenceImageUrl;
                    console.log("✅ Residence image uploaded to ImgBB:", residenceImageUrl);
                } catch (uploadError) {
                    console.error('Error uploading residence image:', uploadError);
                    showNotification(getTranslation('❌ حدث خطأ في رفع صورة الإقامة', '❌ Error uploading residence photo', '❌ رہائشی تصویر اپ لوڈ کرنے میں خرابی'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // رفع صورة الرخصة
                try {
                    showNotification(getTranslation('📸 جاري رفع صورة الرخصة...', '📸 Uploading license photo...', '📸 لائسنس تصویر اپ لوڈ ہو رہی ہے...'), 'info');
                    licenseImageUrl = await uploadToImgBB(systemState.selectedLicenseImage);
                    formData.licenseImageUrl = licenseImageUrl;
                    console.log("✅ License image uploaded to ImgBB:", licenseImageUrl);
                } catch (uploadError) {
                    console.error('Error uploading license image:', uploadError);
                    showNotification(getTranslation('❌ حدث خطأ في رفع صورة الرخصة', '❌ Error uploading license photo', '❌ لائسنس تصویر اپ لوڈ کرنے میں خرابی'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // إذا كان هناك تعديل، قم بتحديث البيانات
                if (systemState.currentEditingId) {
                    await window.firestoreFunctions.updateDoc(
                        window.firestoreFunctions.doc(window.db, "jobApplications", systemState.currentEditingId),
                        formData
                    );
                    showNotification(getTranslation('✅ تم تحديث طلب التوظيف بنجاح', '✅ Job application updated successfully', '✅ ملازمت کی درخواست کامیابی سے اپ ڈیٹ ہو گئی'), 'success');
                    systemState.currentEditingId = null;
                } else {
                    // إذا كان طلب جديد، قم بإضافة البيانات
                    const docRef = await window.firestoreFunctions.addDoc(
                        window.firestoreFunctions.collection(window.db, "jobApplications"), 
                        formData
                    );
                    showNotification(getTranslation('✅ تم إرسال طلب التوظيف بنجاح', '✅ Job application submitted successfully', '✅ ملازمت کی درخواست کامیابی سے جمع ہو گئی'), 'success');
                }
                
                resetForm();
                
                setTimeout(() => {
                    showSuccessMessage();
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting form:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء إرسال الطلب', '❌ Error submitting request', '❌ درخواست جمع کرانے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية للكتابة في قاعدة البيانات', '❌ Permission denied to write to database', '❌ ڈیٹا بیس میں لکھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function submitAdvanceRequest(event) {
            event.preventDefault();
            
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const submitBtn = document.getElementById('submitAdvanceBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري الحفظ...', 'Saving...', 'محفوظ ہو رہا ہے...');
                submitBtn.disabled = true;

                const formData = {
                    employeeName: document.getElementById('employeeName').value.trim(),
                    project: document.getElementById('project').value.trim(),
                    residenceNumber: document.getElementById('residenceNumber').value.trim(),
                    vehicleType: document.getElementById('advanceVehicleType').value,
                    motorcyclePlate: document.getElementById('motorcyclePlate').value.trim(),
                    carPlate: document.getElementById('carPlate').value.trim(),
                    amount: document.getElementById('advanceAmount').value,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date(),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                if (!formData.employeeName || !formData.project || !formData.residenceNumber || !formData.vehicleType || !formData.amount) {
                    showNotification(getTranslation('❌ يرجى ملء جميع الحقول المطلوبة', '❌ Please fill all required fields', '❌ براہ کرم تمام ضروری فیلڈز کو پُر کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // التحقق من أرقام اللوحات بناءً على نوع المركبة
                if (formData.vehicleType === 'دباب' && !formData.motorcyclePlate) {
                    showNotification(getTranslation('❌ يرجى إدخال رقم لوحة الدباب', '❌ Please enter motorcycle plate number', '❌ براہ کرم موٹرسائیکل پلیٹ نمبر درج کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                if (formData.vehicleType === 'سيارة' && !formData.carPlate) {
                    showNotification(getTranslation('❌ يرجى إدخال رقم لوحة السيارة', '❌ Please enter car plate number', '❌ براہ کرم کار پلیٹ نمبر درج کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                if (formData.vehicleType === 'كلاهما' && (!formData.motorcyclePlate || !formData.carPlate)) {
                    showNotification(getTranslation('❌ يرجى إدخال أرقام لوحات الدباب والسيارة', '❌ Please enter both motorcycle and car plate numbers', '❌ براہ کرم موٹرسائیکل اور کار دونوں کی پلیٹ نمبر درج کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // إذا كان هناك تعديل، قم بتحديث البيانات
                if (systemState.currentEditingId) {
                    await window.firestoreFunctions.updateDoc(
                        window.firestoreFunctions.doc(window.db, "advanceRequests", systemState.currentEditingId),
                        formData
                    );
                    showNotification(getTranslation('✅ تم تحديث طلب السلفية بنجاح', '✅ Advance request updated successfully', '✅ ایڈوانس کی درخواست کامیابی سے اپ ڈیٹ ہو گئی'), 'success');
                    systemState.currentEditingId = null;
                } else {
                    // إذا كان طلب جديد، قم بإضافة البيانات
                    const docRef = await window.firestoreFunctions.addDoc(
                        window.firestoreFunctions.collection(window.db, "advanceRequests"), 
                        formData
                    );
                    showNotification(getTranslation('✅ تم حفظ طلب السلفية بنجاح', '✅ Advance request saved successfully', '✅ ایڈوانس کی درخواست کامیابی سے محفوظ ہو گئی'), 'success');
                }
                
                document.getElementById('advanceRequestForm').reset();
                
                setTimeout(() => {
                    showAdvanceRequestsSection();
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting advance request:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء حفظ طلب السلفية', '❌ Error saving advance request', '❌ ایڈوانس کی درخواست محفوظ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية للكتابة في قاعدة البيانات', '❌ Permission denied to write to database', '❌ ڈیٹا بیس میں لکھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function submitRepresentativeForm(event) {
            event.preventDefault();
            
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const submitBtn = document.getElementById('submitRepresentativeBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري الحفظ...', 'Saving...', 'محفوظ ہو رہا ہے...');
                submitBtn.disabled = true;

                const formData = {
                    fullName: document.getElementById('representativeName').value.trim(),
                    idNumber: document.getElementById('representativeId').value.trim(),
                    phoneNumber: document.getElementById('representativePhone').value.trim(),
                    residenceNumber: document.getElementById('representativeResidenceNumber').value.trim(),
                    region: document.getElementById('representativeRegion').value.trim(),
                    vehicleType: document.getElementById('representativeVehicleType').value,
                    plateNumber: document.getElementById('representativePlate').value.trim(),
                    carType: document.getElementById('representativeCarType').value || '',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date(),
                    status: 'active',
                    createdAt: new Date().toISOString()
                };

                if (!formData.fullName || !formData.idNumber || !formData.phoneNumber || !formData.residenceNumber || 
                    !formData.region || !formData.vehicleType || !formData.plateNumber) {
                    showNotification(getTranslation('❌ يرجى ملء جميع الحقول المطلوبة', '❌ Please fill all required fields', '❌ براہ کرم تمام ضروری فیلڈز کو پُر کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // إذا كان هناك تعديل، قم بتحديث البيانات
                if (systemState.currentEditingId) {
                    await window.firestoreFunctions.updateDoc(
                        window.firestoreFunctions.doc(window.db, "representatives", systemState.currentEditingId),
                        formData
                    );
                    showNotification(getTranslation('✅ تم تحديث بيانات المندوب بنجاح', '✅ Representative data updated successfully', '✅ نمائندہ کا ڈیٹا کامیابی سے اپ ڈیٹ ہو گیا'), 'success');
                    systemState.currentEditingId = null;
                } else {
                    // إذا كان مندوب جديد، قم بإضافة البيانات
                    const docRef = await window.firestoreFunctions.addDoc(
                        window.firestoreFunctions.collection(window.db, "representatives"), 
                        formData
                    );
                    showNotification(getTranslation('✅ تم حفظ بيانات المندوب بنجاح', '✅ Representative data saved successfully', '✅ نمائندہ کا ڈیٹا کامیابی سے محفوظ ہو گیا'), 'success');
                }
                
                document.getElementById('representativeForm').reset();
                
                setTimeout(() => {
                    showRepresentativesSection();
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting representative form:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء حفظ بيانات المندوب', '❌ Error saving representative data', '❌ نمائندہ کا ڈیٹا محفوظ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية للكتابة في قاعدة البيانات', '❌ Permission denied to write to database', '❌ ڈیٹا بیس میں لکھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function submitSupervisorForm(event) {
            event.preventDefault();
            
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const submitBtn = document.getElementById('submitSupervisorBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري الحفظ...', 'Saving...', 'محفوظ ہو رہا ہے...');
                submitBtn.disabled = true;

                const fullName = document.getElementById('supervisorFullName').value.trim();
                const username = document.getElementById('supervisorUsername').value.trim();
                const password = document.getElementById('supervisorPassword').value;
                const confirmPassword = document.getElementById('supervisorConfirmPassword').value;

                if (!fullName || !username || !password || !confirmPassword) {
                    showNotification(getTranslation('❌ يرجى ملء جميع الحقول المطلوبة', '❌ Please fill all required fields', '❌ براہ کرم تمام ضروری فیلڈز کو پُر کریں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                if (password !== confirmPassword) {
                    showNotification(getTranslation('❌ كلمات المرور غير متطابقة', '❌ Passwords do not match', '❌ پاس ورڈ مماثل نہیں ہیں'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                // التحقق من عدم تكرار اسم المستخدم
                const q = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, "supervisors"),
                    window.firestoreFunctions.where("username", "==", username)
                );
                
                const querySnapshot = await window.firestoreFunctions.getDocs(q);
                
                if (!querySnapshot.empty && !systemState.currentEditingId) {
                    showNotification(getTranslation('❌ اسم المستخدم موجود مسبقاً', '❌ Username already exists', '❌ صارف نام پہلے سے موجود ہے'), 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                const formData = {
                    fullName: fullName,
                    username: username,
                    password: password,
                    permissions: {
                        jobApps: document.getElementById('permissionJobApps').checked,
                        advances: document.getElementById('permissionAdvances').checked,
                        representatives: document.getElementById('permissionRepresentatives').checked,
                        admins: document.getElementById('permissionAdmins').checked,
                        reports: document.getElementById('permissionReports').checked
                    },
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date(),
                    createdAt: new Date().toISOString()
                };

                // إذا كان هناك تعديل، قم بتحديث البيانات
                if (systemState.currentEditingId) {
                    await window.firestoreFunctions.updateDoc(
                        window.firestoreFunctions.doc(window.db, "supervisors", systemState.currentEditingId),
                        formData
                    );
                    showNotification(getTranslation('✅ تم تحديث بيانات المشرف بنجاح', '✅ Supervisor data updated successfully', '✅ سپروائزر کا ڈیٹا کامیابی سے اپ ڈیٹ ہو گیا'), 'success');
                    systemState.currentEditingId = null;
                } else {
                    // إذا كان مشرف جديد، قم بإضافة البيانات
                    const docRef = await window.firestoreFunctions.addDoc(
                        window.firestoreFunctions.collection(window.db, "supervisors"), 
                        formData
                    );
                    showNotification(getTranslation('✅ تم حفظ بيانات المشرف بنجاح', '✅ Supervisor data saved successfully', '✅ سپروائزر کا ڈیٹا کامیابی سے محفوظ ہو گیا'), 'success');
                }
                
                document.getElementById('supervisorForm').reset();
                
                setTimeout(() => {
                    showAdminsSection();
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting supervisor form:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء حفظ بيانات المشرف', '❌ Error saving supervisor data', '❌ سپروائزر کا ڈیٹا محفوظ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية للكتابة في قاعدة البيانات', '❌ Permission denied to write to database', '❌ ڈیٹا بیس میں لکھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function loadJobApplications() {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const loadBtn = document.getElementById('loadDataBtn');
            const originalText = loadBtn.innerHTML;
            const tableBody = document.getElementById('applicationsTableBody');
            
            try {
                loadBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري التحميل...', 'Loading...', 'لوڈ ہو رہا ہے...');
                loadBtn.disabled = true;
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center">' + getTranslation('جاري تحميل البيانات...', 'Loading data...', 'ڈیٹا لوڈ ہو رہا ہے...') + '</td></tr>';

                const filterName = document.getElementById('filterName').value.toLowerCase();
                const filterDate = document.getElementById('filterDate').value;
                const filterResidenceStatus = document.getElementById('filterResidenceStatus').value;

                const q = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, "jobApplications"),
                    window.firestoreFunctions.orderBy("timestamp", "desc")
                );
                
                const querySnapshot = await window.firestoreFunctions.getDocs(q);
                const applicationsData = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    applicationsData.push(data);
                });

                const filteredData = applicationsData.filter(item => {
                    const matchName = !filterName || (item.fullName && item.fullName.toLowerCase().includes(filterName));
                    const matchDate = !filterDate || item.date === filterDate;
                    const matchResidenceStatus = !filterResidenceStatus || item.residenceStatus === filterResidenceStatus;
                    return matchName && matchDate && matchResidenceStatus;
                });

                tableBody.innerHTML = '';

                if (filteredData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="12" class="text-center">' + getTranslation('لا توجد بيانات مطابقة', 'No matching data found', 'کوئی مماثل ڈیٹا نہیں ملا') + '</td></tr>';
                    return;
                }

                filteredData.forEach(item => {
                    const residenceStatusBadge = item.residenceStatus === 'active' ? 
                        '<span class="status-badge status-active">' + getTranslation('سارية', 'Active', 'درست') + '</span>' :
                        '<span class="status-badge status-expired">' + getTranslation('منتهية', 'Expired', 'ختم') + '</span>';
                    
                    const licenseStatusBadge = item.licenseStatus === 'active' ? 
                        '<span class="status-badge status-active">' + getTranslation('سارية', 'Active', 'درست') + '</span>' :
                        '<span class="status-badge status-expired">' + getTranslation('منتهية', 'Expired', 'ختم') + '</span>';
                    
                    const row = `
                        <tr data-id="${item.id}">
                            <td>${item.fullName || '-'}</td>
                            <td>${item.phoneNumber || '-'}</td>
                            <td>${item.vehicleType || '-'}</td>
                            <td>${item.vehiclePlate || '-'}</td>
                            <td>${item.residenceExpiry || '-'}</td>
                            <td>${residenceStatusBadge}</td>
                            <td>${item.licenseExpiry || '-'}</td>
                            <td>${licenseStatusBadge}</td>
                            <td>
                                ${item.residenceImageUrl ? 
                                    `<a href="${item.residenceImageUrl}" target="_blank" class="btn btn-primary btn-small">
                                        <i class="fas fa-eye"></i> ${getTranslation('عرض', 'View', 'دیکھیں')}
                                    </a>` : 
                                    '-'
                                }
                            </td>
                            <td>
                                ${item.licenseImageUrl ? 
                                    `<a href="${item.licenseImageUrl}" target="_blank" class="btn btn-primary btn-small">
                                        <i class="fas fa-eye"></i> ${getTranslation('عرض', 'View', 'دیکھیں')}
                                    </a>` : 
                                    '-'
                                }
                            </td>
                            <td>${item.date || '-'}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-warning btn-small" onclick="editApplication('${item.id}')">
                                        <i class="fas fa-edit"></i> ${getTranslation('تعديل', 'Edit', 'ترمیم')}
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteApplication('${item.id}')">
                                        <i class="fas fa-trash"></i> ${getTranslation('حذف', 'Delete', 'حذف کریں')}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                showNotification(getTranslation('✅ تم تحميل ', '✅ Loaded ', '✅ لوڈ ہو گیا ') + filteredData.length + getTranslation(' طلب', ' applications', ' درخواستیں'), 'success');

            } catch (error) {
                console.error('Error loading data:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء تحميل البيانات', '❌ Error loading data', '❌ ڈیٹا لوڈ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية لقراءة البيانات', '❌ Permission denied to read data', '❌ ڈیٹا پڑھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center">' + getTranslation('حدث خطأ في تحميل البيانات', 'Error loading data', 'ڈیٹا لوڈ کرنے میں خرابی') + '</td></tr>';
            } finally {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }

        async function loadAdvanceRequests() {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const loadBtn = document.getElementById('loadAdvanceDataBtn');
            const originalText = loadBtn.innerHTML;
            const tableBody = document.getElementById('advanceRequestsTableBody');
            
            try {
                loadBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري التحميل...', 'Loading...', 'لوڈ ہو رہا ہے...');
                loadBtn.disabled = true;
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">' + getTranslation('جاري تحميل البيانات...', 'Loading data...', 'ڈیٹا لوڈ ہو رہا ہے...') + '</td></tr>';

                const filterEmployeeName = document.getElementById('filterEmployeeName').value.toLowerCase();
                const filterAdvanceDate = document.getElementById('filterAdvanceDate').value;

                const q = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, "advanceRequests"),
                    window.firestoreFunctions.orderBy("timestamp", "desc")
                );
                
                const querySnapshot = await window.firestoreFunctions.getDocs(q);
                const advanceRequestsData = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    advanceRequestsData.push(data);
                });

                const filteredData = advanceRequestsData.filter(item => {
                    const matchName = !filterEmployeeName || (item.employeeName && item.employeeName.toLowerCase().includes(filterEmployeeName));
                    const matchDate = !filterAdvanceDate || item.date === filterAdvanceDate;
                    return matchName && matchDate;
                });

                tableBody.innerHTML = '';

                if (filteredData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">' + getTranslation('لا توجد بيانات مطابقة', 'No matching data found', 'کوئی مماثل ڈیٹا نہیں ملا') + '</td></tr>';
                    return;
                }

                filteredData.forEach(item => {
                    const statusBadge = item.status === 'approved' ? 
                        '<span class="status-badge status-active">' + getTranslation('موافق', 'Approved', 'منظور') + '</span>' :
                        '<span class="status-badge status-warning">' + getTranslation('معلق', 'Pending', 'زیر التواء') + '</span>';
                    
                    const row = `
                        <tr data-id="${item.id}">
                            <td>${item.employeeName || '-'}</td>
                            <td>${item.project || '-'}</td>
                            <td>${item.residenceNumber || '-'}</td>
                            <td>${item.vehicleType || '-'}</td>
                            <td>${item.motorcyclePlate || '-'}</td>
                            <td>${item.carPlate || '-'}</td>
                            <td>${item.amount || '-'} ${getTranslation('ريال', 'SAR', 'ریال')}</td>
                            <td>${item.date || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-warning btn-small" onclick="editAdvanceRequest('${item.id}')">
                                        <i class="fas fa-edit"></i> ${getTranslation('تعديل', 'Edit', 'ترمیم')}
                                    </button>
                                    <button class="btn btn-success btn-small" onclick="approveAdvanceRequest('${item.id}')">
                                        <i class="fas fa-check"></i> ${getTranslation('موافقة', 'Approve', 'منظوری')}
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteAdvanceRequest('${item.id}')">
                                        <i class="fas fa-trash"></i> ${getTranslation('حذف', 'Delete', 'حذف کریں')}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                showNotification(getTranslation('✅ تم تحميل ', '✅ Loaded ', '✅ لوڈ ہو گیا ') + filteredData.length + getTranslation(' طلب سلفية', ' advance requests', ' ایڈوانس کی درخواستیں'), 'success');

            } catch (error) {
                console.error('Error loading advance requests:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء تحميل البيانات', '❌ Error loading data', '❌ ڈیٹا لوڈ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية لقراءة البيانات', '❌ Permission denied to read data', '❌ ڈیٹا پڑھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">' + getTranslation('حدث خطأ في تحميل البيانات', 'Error loading data', 'ڈیٹا لوڈ کرنے میں خرابی') + '</td></tr>';
            } finally {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }

        async function loadRepresentatives() {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const loadBtn = document.getElementById('loadRepresentativesBtn');
            const originalText = loadBtn.innerHTML;
            const tableBody = document.getElementById('representativesTableBody');
            
            try {
                loadBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري التحميل...', 'Loading...', 'لوڈ ہو رہا ہے...');
                loadBtn.disabled = true;
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">' + getTranslation('جاري تحميل البيانات...', 'Loading data...', 'ڈیٹا لوڈ ہو رہا ہے...') + '</td></tr>';

                const filterName = document.getElementById('filterRepresentativeName').value.toLowerCase();
                const filterRegion = document.getElementById('filterRepresentativeRegion').value.toLowerCase();

                const q = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, "representatives"),
                    window.firestoreFunctions.orderBy("timestamp", "desc")
                );
                
                const querySnapshot = await window.firestoreFunctions.getDocs(q);
                const representativesData = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    representativesData.push(data);
                });

                const filteredData = representativesData.filter(item => {
                    const matchName = !filterName || (item.fullName && item.fullName.toLowerCase().includes(filterName));
                    const matchRegion = !filterRegion || (item.region && item.region.toLowerCase().includes(filterRegion));
                    return matchName && matchRegion;
                });

                tableBody.innerHTML = '';

                if (filteredData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">' + getTranslation('لا توجد بيانات مطابقة', 'No matching data found', 'کوئی مماثل ڈیٹا نہیں ملا') + '</td></tr>';
                    return;
                }

                filteredData.forEach(item => {
                    const row = `
                        <tr data-id="${item.id}">
                            <td>${item.fullName || '-'}</td>
                            <td>${item.idNumber || '-'}</td>
                            <td>${item.phoneNumber || '-'}</td>
                            <td>${item.residenceNumber || '-'}</td>
                            <td>${item.region || '-'}</td>
                            <td>${item.vehicleType || '-'}</td>
                            <td>${item.plateNumber || '-'}</td>
                            <td>${item.carType || '-'}</td>
                            <td>${item.date || '-'}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-warning btn-small" onclick="editRepresentative('${item.id}')">
                                        <i class="fas fa-edit"></i> ${getTranslation('تعديل', 'Edit', 'ترمیم')}
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteRepresentative('${item.id}')">
                                        <i class="fas fa-trash"></i> ${getTranslation('حذف', 'Delete', 'حذف کریں')}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                showNotification(getTranslation('✅ تم تحميل ', '✅ Loaded ', '✅ لوڈ ہو گیا ') + filteredData.length + getTranslation(' مندوب', ' representatives', ' نمائندے'), 'success');

            } catch (error) {
                console.error('Error loading representatives:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء تحميل البيانات', '❌ Error loading data', '❌ ڈیٹا لوڈ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية لقراءة البيانات', '❌ Permission denied to read data', '❌ ڈیٹا پڑھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">' + getTranslation('حدث خطأ في تحميل البيانات', 'Error loading data', 'ڈیٹا لوڈ کرنے میں خرابی') + '</td></tr>';
            } finally {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }

        async function loadSupervisors() {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            const loadBtn = document.getElementById('loadSupervisorsBtn');
            const originalText = loadBtn.innerHTML;
            const tableBody = document.getElementById('supervisorsTableBody');
            
            try {
                loadBtn.innerHTML = '<div class="loading"></div> ' + getTranslation('جاري التحميل...', 'Loading...', 'لوڈ ہو رہا ہے...');
                loadBtn.disabled = true;
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">' + getTranslation('جاري تحميل البيانات...', 'Loading data...', 'ڈیٹا لوڈ ہو رہا ہے...') + '</td></tr>';

                const q = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, "supervisors"),
                    window.firestoreFunctions.orderBy("timestamp", "desc")
                );
                
                const querySnapshot = await window.firestoreFunctions.getDocs(q);
                const supervisorsData = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    supervisorsData.push(data);
                });

                tableBody.innerHTML = '';

                if (supervisorsData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">' + getTranslation('لا توجد بيانات', 'No data found', 'کوئی ڈیٹا نہیں ملا') + '</td></tr>';
                    return;
                }

                supervisorsData.forEach(item => {
                    const permissions = item.permissions || {};
                    const permissionsText = [];
                    
                    if (permissions.jobApps) permissionsText.push(getTranslation('طلبات التوظيف', 'Job Applications', 'ملازمت کی درخواستیں'));
                    if (permissions.advances) permissionsText.push(getTranslation('السلفيات', 'Advances', 'ایڈوانس'));
                    if (permissions.representatives) permissionsText.push(getTranslation('المندوبين', 'Representatives', 'نمائندے'));
                    if (permissions.admins) permissionsText.push(getTranslation('المشرفين', 'Supervisors', 'سپروائزر'));
                    if (permissions.reports) permissionsText.push(getTranslation('التقارير', 'Reports', 'رپورٹس'));
                    
                    const row = `
                        <tr data-id="${item.id}">
                            <td>${item.fullName || '-'}</td>
                            <td>${item.username || '-'}</td>
                            <td>${permissionsText.join(', ') || '-'}</td>
                            <td>${item.date || '-'}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-warning btn-small" onclick="editSupervisor('${item.id}')">
                                        <i class="fas fa-edit"></i> ${getTranslation('تعديل', 'Edit', 'ترمیم')}
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteSupervisor('${item.id}')">
                                        <i class="fas fa-trash"></i> ${getTranslation('حذف', 'Delete', 'حذف کریں')}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                showNotification(getTranslation('✅ تم تحميل ', '✅ Loaded ', '✅ لوڈ ہو گیا ') + supervisorsData.length + getTranslation(' مشرف', ' supervisors', ' سپروائزر'), 'success');

            } catch (error) {
                console.error('Error loading supervisors:', error);
                let errorMessage = getTranslation('❌ حدث خطأ أثناء تحميل البيانات', '❌ Error loading data', '❌ ڈیٹا لوڈ کرنے میں خرابی');
                
                if (error.code === 'permission-denied') {
                    errorMessage = getTranslation('❌ ليس لديك صلاحية لقراءة البيانات', '❌ Permission denied to read data', '❌ ڈیٹا پڑھنے کی اجازت نہیں ہے');
                }
                
                showNotification(errorMessage, 'error');
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">' + getTranslation('حدث خطأ في تحميل البيانات', 'Error loading data', 'ڈیٹا لوڈ کرنے میں خرابی') + '</td></tr>';
            } finally {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }

        async function generateReports() {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            try {
                // إحصائيات طلبات التوظيف
                const jobAppsSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "jobApplications")
                );
                document.getElementById('reportTotalApplications').textContent = jobAppsSnapshot.size;
                
                // إحصائيات المندوبين النشطين
                const repsSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "representatives")
                );
                document.getElementById('reportActiveRepresentatives').textContent = repsSnapshot.size;
                
                // إحصائيات طلبات السلفيات المعلقة
                const advancesSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "advanceRequests")
                );
                let pendingAdvances = 0;
                advancesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'pending') pendingAdvances++;
                });
                document.getElementById('reportPendingAdvances').textContent = pendingAdvances;
                
                // إحصائيات المشرفين
                const supervisorsSnapshot = await window.firestoreFunctions.getDocs(
                    window.firestoreFunctions.collection(window.db, "supervisors")
                );
                document.getElementById('reportTotalSupervisors').textContent = supervisorsSnapshot.size;
                
                showNotification(getTranslation('✅ تم تحديث التقارير بنجاح', '✅ Reports updated successfully', '✅ رپورٹس کامیابی سے اپ ڈیٹ ہو گئیں'), 'success');
                
            } catch (error) {
                console.error('Error generating reports:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تحديث التقارير', '❌ Error updating reports', '❌ رپورٹس اپ ڈیٹ کرنے میں خرابی'), 'error');
            }
        }

        // دالة تعديل طلب التوظيف
        async function editApplication(applicationId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            try {
                const docRef = window.firestoreFunctions.doc(window.db, "jobApplications", applicationId);
                const docSnap = await window.firestoreFunctions.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // تعبئة النموذج بالبيانات
                    document.getElementById('fullName').value = data.fullName || '';
                    document.getElementById('phoneNumber').value = data.phoneNumber || '';
                    document.getElementById('vehicleType').value = data.vehicleType || '';
                    document.getElementById('vehiclePlate').value = data.vehiclePlate || '';
                    document.getElementById('residenceExpiry').value = data.residenceExpiry || '';
                    document.getElementById('licenseExpiry').value = data.licenseExpiry || '';
                    
                    // تحديث حالة النظام
                    systemState.currentEditingId = applicationId;
                    
                    // تغيير نص زر الإرسال
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> <span data-ar="تحديث الطلب" data-en="Update Application" data-ur="درخواست اپ ڈیٹ کریں">تحديث الطلب</span>';
                    
                    // إظهار نموذج التقديم
                    showJobApplicationForm();
                    
                    showNotification(getTranslation('✅ تم تحميل بيانات الطلب للتعديل', '✅ Application data loaded for editing', '✅ ترمیم کے لیے درخواست کا ڈیٹا لوڈ ہو گیا'), 'success');
                } else {
                    showNotification(getTranslation('❌ لم يتم العثور على الطلب', '❌ Application not found', '❌ درخواست نہیں ملی'), 'error');
                }
            } catch (error) {
                console.error('Error loading application for editing:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تحميل بيانات الطلب', '❌ Error loading application data', '❌ درخواست کا ڈیٹا لوڈ کرنے میں خرابی'), 'error');
            }
        }

        // دالة تعديل طلب السلفية
        async function editAdvanceRequest(advanceId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            try {
                const docRef = window.firestoreFunctions.doc(window.db, "advanceRequests", advanceId);
                const docSnap = await window.firestoreFunctions.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // تعبئة النموذج بالبيانات
                    document.getElementById('employeeName').value = data.employeeName || '';
                    document.getElementById('project').value = data.project || '';
                    document.getElementById('residenceNumber').value = data.residenceNumber || '';
                    document.getElementById('advanceVehicleType').value = data.vehicleType || '';
                    document.getElementById('motorcyclePlate').value = data.motorcyclePlate || '';
                    document.getElementById('carPlate').value = data.carPlate || '';
                    document.getElementById('advanceAmount').value = data.amount || '';
                    
                    // تحديث حالة النظام
                    systemState.currentEditingId = advanceId;
                    
                    // تحديث حقول اللوحات بناءً على نوع المركبة
                    toggleAdvancePlateFields();
                    
                    // تغيير نص زر الإرسال
                    const submitBtn = document.getElementById('submitAdvanceBtn');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> <span data-ar="تحديث طلب السلفية" data-en="Update Advance Request" data-ur="ایڈوانس کی درخواست اپ ڈیٹ کریں">تحديث طلب السلفية</span>';
                    
                    // إظهار نموذج إضافة طلب السلفية
                    showAddAdvanceRequestForm();
                    
                    showNotification(getTranslation('✅ تم تحميل بيانات طلب السلفية للتعديل', '✅ Advance request data loaded for editing', '✅ ترمیم کے لیے ایڈوانس کی درخواست کا ڈیٹا لوڈ ہو گیا'), 'success');
                } else {
                    showNotification(getTranslation('❌ لم يتم العثور على طلب السلفية', '❌ Advance request not found', '❌ ایڈوانس کی درخواست نہیں ملی'), 'error');
                }
            } catch (error) {
                console.error('Error loading advance request for editing:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تحميل بيانات طلب السلفية', '❌ Error loading advance request data', '❌ ایڈوانس کی درخواست کا ڈیٹا لوڈ کرنے میں خرابی'), 'error');
            }
        }

        // دالة تعديل المندوب
        async function editRepresentative(representativeId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            try {
                const docRef = window.firestoreFunctions.doc(window.db, "representatives", representativeId);
                const docSnap = await window.firestoreFunctions.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // تعبئة النموذج بالبيانات
                    document.getElementById('representativeName').value = data.fullName || '';
                    document.getElementById('representativeId').value = data.idNumber || '';
                    document.getElementById('representativePhone').value = data.phoneNumber || '';
                    document.getElementById('representativeResidenceNumber').value = data.residenceNumber || '';
                    document.getElementById('representativeRegion').value = data.region || '';
                    document.getElementById('representativeVehicleType').value = data.vehicleType || '';
                    document.getElementById('representativePlate').value = data.plateNumber || '';
                    document.getElementById('representativeCarType').value = data.carType || '';
                    
                    // تحديث حالة النظام
                    systemState.currentEditingId = representativeId;
                    
                    // تحديث حقول المركبة
                    toggleRepresentativeVehicleFields();
                    
                    // تغيير نص زر الإرسال
                    const submitBtn = document.getElementById('submitRepresentativeBtn');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> <span data-ar="تحديث بيانات المندوب" data-en="Update Representative Data" data-ur="نمائندہ کا ڈیٹا اپ ڈیٹ کریں">تحديث بيانات المندوب</span>';
                    
                    // إظهار نموذج إضافة المندوب
                    showAddRepresentativeForm();
                    
                    showNotification(getTranslation('✅ تم تحميل بيانات المندوب للتعديل', '✅ Representative data loaded for editing', '✅ ترمیم کے لیے نمائندہ کا ڈیٹا لوڈ ہو گیا'), 'success');
                } else {
                    showNotification(getTranslation('❌ لم يتم العثور على المندوب', '❌ Representative not found', '❌ نمائندہ نہیں ملا'), 'error');
                }
            } catch (error) {
                console.error('Error loading representative for editing:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تحميل بيانات المندوب', '❌ Error loading representative data', '❌ نمائندہ کا ڈیٹا لوڈ کرنے میں خرابی'), 'error');
            }
        }

        // دالة تعديل المشرف
        async function editSupervisor(supervisorId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            try {
                const docRef = window.firestoreFunctions.doc(window.db, "supervisors", supervisorId);
                const docSnap = await window.firestoreFunctions.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const permissions = data.permissions || {};
                    
                    // تعبئة النموذج بالبيانات
                    document.getElementById('supervisorFullName').value = data.fullName || '';
                    document.getElementById('supervisorUsername').value = data.username || '';
                    document.getElementById('supervisorPassword').value = data.password || '';
                    document.getElementById('supervisorConfirmPassword').value = data.password || '';
                    
                    // تعبئة الصلاحيات
                    document.getElementById('permissionJobApps').checked = permissions.jobApps || false;
                    document.getElementById('permissionAdvances').checked = permissions.advances || false;
                    document.getElementById('permissionRepresentatives').checked = permissions.representatives || false;
                    document.getElementById('permissionAdmins').checked = permissions.admins || false;
                    document.getElementById('permissionReports').checked = permissions.reports || false;
                    
                    // تحديث حالة النظام
                    systemState.currentEditingId = supervisorId;
                    
                    // تغيير نص زر الإرسال
                    const submitBtn = document.getElementById('submitSupervisorBtn');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> <span data-ar="تحديث بيانات المشرف" data-en="Update Supervisor Data" data-ur="سپروائزر کا ڈیٹا اپ ڈیٹ کریں">تحديث بيانات المشرف</span>';
                    
                    // إظهار نموذج إضافة المشرف
                    showAddSupervisorForm();
                    
                    showNotification(getTranslation('✅ تم تحميل بيانات المشرف للتعديل', '✅ Supervisor data loaded for editing', '✅ ترمیم کے لیے سپروائزر کا ڈیٹا لوڈ ہو گیا'), 'success');
                } else {
                    showNotification(getTranslation('❌ لم يتم العثور على المشرف', '❌ Supervisor not found', '❌ سپروائزر نہیں ملا'), 'error');
                }
            } catch (error) {
                console.error('Error loading supervisor for editing:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تحميل بيانات المشرف', '❌ Error loading supervisor data', '❌ سپروائزر کا ڈیٹا لوڈ کرنے میں خرابی'), 'error');
            }
        }

        async function deleteApplication(applicationId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            if (!confirm(getTranslation('هل أنت متأكد من حذف هذا الطلب؟', 'Are you sure you want to delete this application?', 'کیا آپ واقعی اس درخواست کو حذف کرنا چاہتے ہیں؟'))) {
                return;
            }

            try {
                await window.firestoreFunctions.deleteDoc(
                    window.firestoreFunctions.doc(window.db, "jobApplications", applicationId)
                );
                
                showNotification(getTranslation('✅ تم حذف الطلب بنجاح', '✅ Application deleted successfully', '✅ درخواست کامیابی سے حذف ہو گئی'), 'success');
                loadJobApplications();
                
            } catch (error) {
                console.error('Error deleting application:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء حذف الطلب', '❌ Error deleting application', '❌ درخواست حذف کرنے میں خرابی'), 'error');
            }
        }

        async function deleteAdvanceRequest(advanceId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            if (!confirm(getTranslation('هل أنت متأكد من حذف طلب السلفية هذا؟', 'Are you sure you want to delete this advance request?', 'کیا آپ واقعی اس ایڈوانس کی درخواست کو حذف کرنا چاہتے ہیں؟'))) {
                return;
            }

            try {
                await window.firestoreFunctions.deleteDoc(
                    window.firestoreFunctions.doc(window.db, "advanceRequests", advanceId)
                );
                
                showNotification(getTranslation('✅ تم حذف طلب السلفية بنجاح', '✅ Advance request deleted successfully', '✅ ایڈوانس کی درخواست کامیابی سے حذف ہو گئی'), 'success');
                loadAdvanceRequests();
                
            } catch (error) {
                console.error('Error deleting advance request:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء حذف طلب السلفية', '❌ Error deleting advance request', '❌ ایڈوانس کی درخواست حذف کرنے میں خرابی'), 'error');
            }
        }

        async function deleteRepresentative(representativeId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            if (!confirm(getTranslation('هل أنت متأكد من حذف هذا المندوب؟', 'Are you sure you want to delete this representative?', 'کیا آپ واقعی اس نمائندہ کو حذف کرنا چاہتے ہیں؟'))) {
                return;
            }

            try {
                await window.firestoreFunctions.deleteDoc(
                    window.firestoreFunctions.doc(window.db, "representatives", representativeId)
                );
                
                showNotification(getTranslation('✅ تم حذف المندوب بنجاح', '✅ Representative deleted successfully', '✅ نمائندہ کامیابی سے حذف ہو گیا'), 'success');
                loadRepresentatives();
                
            } catch (error) {
                console.error('Error deleting representative:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء حذف المندوب', '❌ Error deleting representative', '❌ نمائندہ حذف کرنے میں خرابی'), 'error');
            }
        }

        async function deleteSupervisor(supervisorId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            if (!confirm(getTranslation('هل أنت متأكد من حذف هذا المشرف؟', 'Are you sure you want to delete this supervisor?', 'کیا آپ واقعی اس سپروائزر کو حذف کرنا چاہتے ہیں؟'))) {
                return;
            }

            try {
                await window.firestoreFunctions.deleteDoc(
                    window.firestoreFunctions.doc(window.db, "supervisors", supervisorId)
                );
                
                showNotification(getTranslation('✅ تم حذف المشرف بنجاح', '✅ Supervisor deleted successfully', '✅ سپروائزر کامیابی سے حذف ہو گیا'), 'success');
                loadSupervisors();
                
            } catch (error) {
                console.error('Error deleting supervisor:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء حذف المشرف', '❌ Error deleting supervisor', '❌ سپروائزر حذف کرنے میں خرابی'), 'error');
            }
        }

        async function approveAdvanceRequest(advanceId) {
            if (!systemState.firebaseReady) {
                showNotification(getTranslation('⏳ جاري الاتصال بقاعدة البيانات...', '⏳ Connecting to database...', '⏳ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                return;
            }

            if (!confirm(getTranslation('هل تريد الموافقة على طلب السلفية هذا؟', 'Do you want to approve this advance request?', 'کیا آپ اس ایڈوانس کی درخواست کو منظور کرنا چاہتے ہیں؟'))) {
                return;
            }

            try {
                await window.firestoreFunctions.updateDoc(
                    window.firestoreFunctions.doc(window.db, "advanceRequests", advanceId),
                    { status: "approved" }
                );
                
                showNotification(getTranslation('✅ تمت الموافقة على طلب السلفية', '✅ Advance request approved', '✅ ایڈوانس کی درخواست منظور ہو گئی'), 'success');
                loadAdvanceRequests();
                
            } catch (error) {
                console.error('Error approving advance request:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء الموافقة على طلب السلفية', '❌ Error approving advance request', '❌ ایڈوانس کی درخواست منظور کرنے میں خرابی'), 'error');
            }
        }

        function exportJobApplicationsToExcel() {
            try {
                const table = document.getElementById('jobApplicationsTable');
                const workbook = XLSX.utils.table_to_book(table, {sheet: "طلبات التوظيف"});
                XLSX.writeFile(workbook, "job_applications.xlsx");
                showNotification(getTranslation('✅ تم تحميل ملف Excel بنجاح', '✅ Excel file downloaded successfully', '✅ ایکسل فائل کامیابی سے ڈاؤن لوڈ ہو گئی'), 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء التصدير', '❌ Error exporting to Excel', '❌ ایکسل میں برآمد کرنے میں خرابی'), 'error');
            }
        }

        function exportAdvanceRequestsToExcel() {
            try {
                const table = document.getElementById('advanceRequestsTable');
                const workbook = XLSX.utils.table_to_book(table, {sheet: "طلبات السلفيات"});
                XLSX.writeFile(workbook, "advance_requests.xlsx");
                showNotification(getTranslation('✅ تم تحميل ملف Excel بنجاح', '✅ Excel file downloaded successfully', '✅ ایکسل فائل کامیابی سے ڈاؤن لوڈ ہو گئی'), 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء التصدير', '❌ Error exporting to Excel', '❌ ایکسل میں برآمد کرنے میں خرابی'), 'error');
            }
        }

        function exportRepresentativesToExcel() {
            try {
                const table = document.getElementById('representativesTable');
                const workbook = XLSX.utils.table_to_book(table, {sheet: "المندوبين"});
                XLSX.writeFile(workbook, "representatives.xlsx");
                showNotification(getTranslation('✅ تم تحميل ملف Excel بنجاح', '✅ Excel file downloaded successfully', '✅ ایکسل فائل کامیابی سے ڈاؤن لوڈ ہو گئی'), 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء التصدير', '❌ Error exporting to Excel', '❌ ایکسل میں برآمد کرنے میں خرابی'), 'error');
            }
        }

        function exportReportsToExcel() {
            try {
                // إنشاء بيانات التقارير
                const reportData = [
                    ['التقرير', 'القيمة'],
                    ['إجمالي طلبات التوظيف', document.getElementById('reportTotalApplications').textContent],
                    ['المندوبين النشطين', document.getElementById('reportActiveRepresentatives').textContent],
                    ['طلبات السلفيات المعلقة', document.getElementById('reportPendingAdvances').textContent],
                    ['إجمالي المشرفين', document.getElementById('reportTotalSupervisors').textContent]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(reportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "التقارير");
                XLSX.writeFile(wb, "reports.xlsx");
                
                showNotification(getTranslation('✅ تم تصدير التقارير بنجاح', '✅ Reports exported successfully', '✅ رپورٹس کامیابی سے برآمد ہو گئیں'), 'success');
            } catch (error) {
                console.error('Error exporting reports:', error);
                showNotification(getTranslation('❌ حدث خطأ أثناء تصدير التقارير', '❌ Error exporting reports', '❌ رپورٹس برآمد کرنے میں خرابی'), 'error');
            }
        }

        // دالة التحويل بين اللغات
        function toggleLanguage() {
            const body = document.body;
            const langToggle = document.getElementById('langText');
            
            if (body.classList.contains('lang-ar')) {
                body.classList.remove('lang-ar');
                body.classList.add('lang-en');
                langToggle.textContent = 'AR';
                document.documentElement.dir = 'ltr';
                document.documentElement.lang = 'en';
                updateLanguage('en');
            } else if (body.classList.contains('lang-en')) {
                body.classList.remove('lang-en');
                body.classList.add('lang-ur');
                langToggle.textContent = 'EN';
                document.documentElement.dir = 'rtl';
                document.documentElement.lang = 'ur';
                updateLanguage('ur');
            } else {
                body.classList.remove('lang-ur');
                body.classList.add('lang-ar');
                langToggle.textContent = 'UR';
                document.documentElement.dir = 'rtl';
                document.documentElement.lang = 'ar';
                updateLanguage('ar');
            }

            if (document.getElementById('supervisorDashboard').style.display === 'block') {
                if (document.getElementById('jobApplicationsSection').style.display !== 'none') {
                    loadJobApplications();
                } else if (document.getElementById('advanceRequestsSection').style.display !== 'none') {
                    loadAdvanceRequests();
                } else if (document.getElementById('representativesSection').style.display !== 'none') {
                    loadRepresentatives();
                } else if (document.getElementById('adminsSection').style.display !== 'none') {
                    loadSupervisors();
                } else if (document.getElementById('reportsSection').style.display !== 'none') {
                    generateReports();
                }
            }
        }

        function updateLanguage(lang) {
            document.querySelectorAll('[data-ar], [data-en], [data-ur]').forEach(element => {
                if (element.hasAttribute(`data-${lang}`)) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('data-ar-placeholder')) {
                        element.placeholder = element.getAttribute(`data-${lang}-placeholder`);
                    } else {
                        element.textContent = element.getAttribute(`data-${lang}`);
                    }
                }
            });

            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.style.direction = lang === 'ar' || lang === 'ur' ? 'rtl' : 'ltr';
            });
        }

        function getTranslation(ar, en, ur) {
            const body = document.body;
            if (body.classList.contains('lang-ar')) return ar;
            if (body.classList.contains('lang-en')) return en;
            if (body.classList.contains('lang-ur')) return ur;
            return ar;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                ${document.body.classList.contains('lang-ar') || document.body.classList.contains('lang-ur') ? 'left: 20px' : 'right: 20px'};
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                max-width: 400px;
            `;

            const colors = {
                success: '#38a169',
                error: '#e53e3e',
                info: '#3182ce',
                warning: '#d69e2e'
            };

            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jobForm').addEventListener('submit', submitJobApplication);
            document.getElementById('advanceRequestForm').addEventListener('submit', submitAdvanceRequest);
            document.getElementById('representativeForm').addEventListener('submit', submitRepresentativeForm);
            document.getElementById('supervisorForm').addEventListener('submit', submitSupervisorForm);
            updateLanguage('ar');
            setTimeout(() => {
                if (!systemState.firebaseReady) {
                    showNotification(getTranslation('⚠️ جاري الاتصال بقاعدة البيانات...', '⚠️ Connecting to database...', '⚠️ ڈیٹا بیس سے منسلک ہو رہا ہے...'), 'warning');
                }
            }, 2000);
            showNotification(getTranslation('مرحباً بك في نظام توظيف الزهراني', 'Welcome to Al-Zahrani Employment System', 'الزہرانی ملازمت کے نظام میں خوش آمدید'), 'info');
        });
    </script>
</body>
</html>
